# Backup and Disaster Recovery Plan: SMB Landing Zone

> Generated by docs agent | 2026-02-02 | Artifact v0.1
> **Environment**: Production
> **Primary Region**: swedencentral
> **Secondary Region**: germanywestcentral (manual failover)

---

## Executive Summary

This document defines the backup strategy and disaster recovery procedures for the SMB Landing Zone.
The design prioritizes **cost optimization over high availability**, meaning recovery involves
rebuilding from Infrastructure as Code rather than automatic failover.

| Metric           | Current       | Target        | Notes                          |
| ---------------- | ------------- | ------------- | ------------------------------ |
| **RPO**          | 24 hours      | 24 hours      | Daily VM backups               |
| **RTO**          | 2-4 hours     | 4 hours       | Bicep redeployment             |
| **Availability** | Best effort   | 99% (soft)    | No SLA commitment              |

---

## 1. Recovery Objectives

### 1.1 Recovery Time Objective (RTO)

| Tier      | RTO Target | Services                              |
| --------- | ---------- | ------------------------------------- |
| Critical  | 2 hours    | VPN connectivity (if deployed)        |
| Important | 4 hours    | Azure Firewall, network routing       |
| Standard  | 8 hours    | Customer VMs, workloads               |

### 1.2 Recovery Point Objective (RPO)

| Data Type           | RPO Target | Backup Strategy                       |
| ------------------- | ---------- | ------------------------------------- |
| VM Disks            | 24 hours   | Daily Azure Backup                    |
| Infrastructure      | 0 (no loss)| Bicep templates in Git                |
| Configuration       | 0 (no loss)| Azure Policy (stateless)              |
| Customer Data       | Varies     | Customer-managed                      |

---

## 2. Backup Strategy

### 2.1 Azure VM Backup

VMs tagged with `Backup: true` are automatically enrolled via Azure Policy.

| Setting             | Configuration                         |
| ------------------- | ------------------------------------- |
| Backup Vault        | rsv-smblz-slz-swc                     |
| Policy              | DefaultVMPolicy                       |
| Schedule            | Daily @ 02:00 UTC                     |
| Instant Recovery    | 2 days                                |
| Daily Retention     | 30 days                               |
| Weekly Retention    | 12 weeks (Sunday)                     |
| Monthly Retention   | 12 months (1st of month)              |
| Yearly Retention    | None                                  |
| Geo-Redundancy      | LRS (Locally Redundant)               |

**Restore VM Command:**

```powershell
# Set vault context
$vault = Get-AzRecoveryServicesVault -Name "rsv-smblz-slz-swc" -ResourceGroupName "rg-backup-slz-swc"
Set-AzRecoveryServicesVaultContext -Vault $vault

# Find recovery points
$container = Get-AzRecoveryServicesBackupContainer -ContainerType AzureVM -FriendlyName "vm-name"
$item = Get-AzRecoveryServicesBackupItem -Container $container -WorkloadType AzureVM
$rp = Get-AzRecoveryServicesBackupRecoveryPoint -Item $item

# Restore to new VM
$restorejob = Restore-AzRecoveryServicesBackupItem -RecoveryPoint $rp[0] -TargetResourceGroupName "rg-spoke-prod-swc" -StorageAccountName "strecoveryswc" -StorageAccountResourceGroupName "rg-backup-slz-swc"
```

### 2.2 Infrastructure Backup

Infrastructure is defined as code and stored in Git:

| Component          | Backup Location                       | Recovery Method              |
| ------------------ | ------------------------------------- | ---------------------------- |
| Bicep Templates    | GitHub repository                     | `./deploy.ps1` redeploy      |
| Azure Policies     | Bicep + Git                           | Auto-applied on deployment   |
| Network Config     | Bicep + Git                           | Auto-applied on deployment   |
| Firewall Rules     | Bicep (firewall.bicep)                | Auto-applied on deployment   |

**Redeploy Infrastructure Command:**

```powershell
cd infra/bicep/smb-landing-zone
./deploy.ps1 -Scenario full -Location swedencentral
```

### 2.3 Data Not Backed Up

| Resource Type      | Reason                                | Mitigation                    |
| ------------------ | ------------------------------------- | ----------------------------- |
| Azure Firewall     | Stateless (rules in Bicep)            | Redeploy from Bicep           |
| VPN Gateway        | Stateless (config in Bicep)           | Redeploy from Bicep           |
| NSG Rules          | Defined in Bicep                      | Redeploy from Bicep           |
| Route Tables       | Defined in Bicep                      | Redeploy from Bicep           |

---

## 3. Disaster Recovery Procedures

### 3.1 Disaster Scenarios

| Scenario                    | Likelihood | Impact   | Recovery Strategy            |
| --------------------------- | ---------- | -------- | ---------------------------- |
| Single VM failure           | Medium     | Low      | Restore from backup          |
| Resource group deletion     | Low        | High     | Redeploy from Bicep          |
| Region outage               | Very Low   | Critical | Redeploy to secondary region |
| Subscription compromise     | Very Low   | Critical | New subscription + redeploy  |

### 3.2 Single VM Recovery

**Time to Recover: 1-2 hours**

1. Identify the failed VM in Azure Portal
2. Navigate to Recovery Services Vault
3. Select the VM's latest recovery point
4. Restore as new VM or replace existing
5. Verify network connectivity
6. Update DNS if necessary

### 3.3 Resource Group Recovery

**Time to Recover: 2-4 hours**

1. Verify Git repository has latest Bicep templates
2. Run cleanup script (if partial resources remain):
   ```powershell
   ./scripts/Remove-SmbLandingZone.ps1 -Location swedencentral -Force
   ```
3. Redeploy infrastructure:
   ```powershell
   ./deploy.ps1 -Scenario full -Location swedencentral
   ```
4. Restore VMs from backup (if applicable)
5. Verify all resources operational

### 3.4 Region Failover

**Time to Recover: 4-8 hours**

> ⚠️ This landing zone does not include automated region failover. Recovery requires manual
> redeployment to a secondary region.

**Procedure:**

1. Confirm region outage via [Azure Status](https://status.azure.com)
2. Update Bicep parameters for secondary region:
   ```powershell
   ./deploy.ps1 -Scenario full -Location germanywestcentral
   ```
3. Wait for infrastructure deployment (~45 min for full scenario)
4. Restore VMs from backup (if GRS enabled - not default)
5. Update DNS records to point to new region
6. Update VPN connections (new gateway IPs)
7. Notify customers of new connectivity details

### 3.5 Failback Procedure

After primary region is restored:

1. Verify primary region is fully operational
2. Evaluate data sync requirements (likely none - LRS backup)
3. Deploy fresh infrastructure to primary region
4. Migrate workloads during maintenance window
5. Delete secondary region resources
6. Update DNS and VPN configurations

---

## 4. Testing Schedule

| Test Type                  | Frequency  | Last Tested | Next Scheduled |
| -------------------------- | ---------- | ----------- | -------------- |
| VM Backup Restore          | Quarterly  | -           | Q2 2026        |
| Infrastructure Redeploy    | Monthly    | 2026-02-02  | 2026-03-01     |
| Region Failover (tabletop) | Annually   | -           | Q4 2026        |
| Full DR Exercise           | Annually   | -           | Q4 2026        |

### 4.1 Quarterly Backup Test Procedure

1. Select a non-production test VM
2. Create a restore to a new VM
3. Verify VM boots and data integrity
4. Delete test VM
5. Document results

### 4.2 Monthly Infrastructure Redeploy Test

1. Deploy to test subscription (or use `-WhatIf`)
2. Verify all resources created correctly
3. Run validation checks
4. Clean up test resources
5. Document any issues found

---

## 5. Communication Plan

### 5.1 Incident Communication

| Phase          | Audience         | Channel          | Template           |
| -------------- | ---------------- | ---------------- | ------------------ |
| Detection      | Ops Team         | Slack/Teams      | "Investigating..." |
| Assessment     | Ops + Management | Email            | Impact assessment  |
| Resolution     | All stakeholders | Email + Portal   | Resolution summary |
| Post-mortem    | Technical team   | Meeting + Doc    | RCA template       |

### 5.2 Escalation Matrix

| Severity | First Contact    | Escalation (30 min) | Escalation (2 hr) |
| -------- | ---------------- | ------------------- | ----------------- |
| P1       | On-call engineer | Team Lead           | Director          |
| P2       | On-call engineer | Team Lead           | -                 |
| P3       | Support queue    | -                   | -                 |

---

## 6. Roles and Responsibilities

| Role                    | Responsibilities                              |
| ----------------------- | --------------------------------------------- |
| Platform Owner          | DR plan approval, budget for DR tests         |
| Operations Lead         | Execute DR procedures, coordinate teams       |
| Network Engineer        | VPN/Firewall recovery, DNS updates            |
| Security Officer        | Verify security controls post-recovery        |
| Customer Success        | Customer communication during incidents       |

---

## 7. Dependencies

### 7.1 Internal Dependencies

| Dependency            | Impact if Unavailable                      |
| --------------------- | ------------------------------------------ |
| Git Repository        | Cannot redeploy infrastructure             |
| Azure Subscription    | Cannot create new resources                |
| Service Principal     | Cannot authenticate deployments            |
| VPN Device (on-prem)  | Cannot restore hybrid connectivity         |

### 7.2 External Dependencies

| Dependency            | Impact if Unavailable                      |
| --------------------- | ------------------------------------------ |
| Azure Region          | Region failover required                   |
| Azure AD              | Cannot authenticate to Azure               |
| GitHub                | Cannot access Bicep templates              |
| Microsoft Support     | Delayed incident resolution                |

---

## 8. Recovery Runbooks

### 8.1 Quick Recovery Commands

```powershell
# Full infrastructure redeploy
cd infra/bicep/smb-landing-zone
./deploy.ps1 -Scenario full -Location swedencentral

# Check deployment status
az deployment sub show --name "smb-lz-prod" --query "properties.provisioningState"

# Restore VM from backup
$vault = Get-AzRecoveryServicesVault -Name "rsv-smblz-slz-swc" -ResourceGroupName "rg-backup-slz-swc"
# ... (see Section 2.1 for full procedure)
```

### 8.2 Validation Checklist

After recovery, verify:

- [ ] Hub VNet accessible
- [ ] Spoke VNet accessible
- [ ] VNet peering connected
- [ ] Azure Firewall running (if deployed)
- [ ] VPN Gateway connected (if deployed)
- [ ] Route tables applied
- [ ] NSG rules active
- [ ] Log Analytics receiving data
- [ ] Backup vault accessible
- [ ] Policy assignments applied
- [ ] Customer VMs restored (if applicable)

---

## 9. Appendix

### A. Contact Information

| Role                | Contact            |
| ------------------- | ------------------ |
| Platform Owner      | {owner-email}      |
| On-Call             | {oncall-number}    |
| Microsoft Support   | https://portal.azure.com/#blade/Microsoft_Azure_Support |

### B. Document History

| Version | Date       | Author      | Changes           |
| ------- | ---------- | ----------- | ----------------- |
| 0.1     | 2026-02-02 | docs agent  | Initial creation  |

---

_Backup and DR plan generated by docs agent for SMB Landing Zone v0.3.0._
