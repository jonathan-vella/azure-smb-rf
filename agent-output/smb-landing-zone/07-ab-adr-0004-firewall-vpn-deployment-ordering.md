# ADR-0004: Firewall and VPN Gateway Deployment Ordering

> Generated by diagnose agent | 2026-02-02 | As-Built Documentation
> **Status**: Accepted

## Context

During validation of the SMB Landing Zone `full` scenario (Firewall + VPN Gateway), we observed intermittent deployment failures with `InternalServerError` on the Azure Firewall resource. The deployment would fail on the first attempt but succeed on retry.

### Observed Behavior

```
Deployment attempt 1: FAILED
  Error: InternalServerError on Microsoft.Network/azureFirewalls

Deployment attempt 2 (after 30s): SUCCEEDED
  All resources provisioned correctly
```

### Root Cause Analysis

Investigation revealed a **race condition** when deploying Azure Firewall and VPN Gateway simultaneously:

1. **Both modules share a dependency**: `networkingHub` (hub VNet)
2. **Both modules modify the hub VNet**:
   - Azure Firewall attaches to `AzureFirewallSubnet`
   - VPN Gateway attaches to `GatewaySubnet`
3. **Parallel deployment conflict**: Azure Resource Manager attempts concurrent VNet updates
4. **Result**: `InternalServerError` when the VNet is locked by one operation while another attempts modification

### Evidence

From the Bicep module documentation:

> "Like resources, modules are deployed in parallel unless they depend on other modules or resources."

From Azure deployment error reference:

> `AnotherOperationInProgress`: Wait for concurrent operation to complete.

## Decision

**Serialize Firewall and VPN Gateway deployments using explicit `dependsOn`.**

When both `deployFirewall` and `deployVpnGateway` are true (full scenario), the VPN Gateway module will wait for the Firewall module to complete before starting its deployment.

### Implementation

```bicep
module vpnGateway 'modules/vpn-gateway.bicep' = if (deployVpnGateway) {
  name: 'vpn-gateway-${uniqueSuffix}'
  scope: resourceGroup(rgNames.hub)
  params: {
    // ... parameters
  }
  // CRITICAL: Serialize VPN Gateway after Firewall to avoid VNet update race condition
  #disable-next-line BCP319
  dependsOn: deployFirewall ? [firewall] : []
}
```

## Consequences

### Positive

- **First-attempt deployment success**: Eliminates the race condition that caused intermittent failures
- **Predictable behavior**: Deployment order is deterministic: Firewall → VPN → Peering
- **Reduced support burden**: No more "retry and it works" scenarios for customers
- **Aligns with Azure best practices**: Security appliances before connectivity gateways

### Negative

- **Longer full scenario deployment time**: Sequential vs parallel adds ~10-15 minutes
  - Before: ~35-40 minutes (parallel)
  - After: ~45-55 minutes (sequential)
- **Template complexity**: Conditional `dependsOn` requires `#disable-next-line BCP319` pragma

### Neutral

- No impact on baseline, firewall-only, or vpn-only scenarios
- VPN Gateway already took 30-45 minutes; serialization doesn't change that

## Alternatives Considered

### 1. Retry Logic Only

Add retry logic with exponential backoff to handle transient failures.

**Rejected because**: This treats the symptom, not the cause. Retries add deployment time and create a poor user experience ("why did it fail the first time?").

### 2. Separate Deployments

Deploy firewall and VPN gateway as separate deployment operations.

**Rejected because**: This breaks the single-template deployment model and complicates the user experience.

### 3. Pre-created Subnets

Create `AzureFirewallSubnet` and `GatewaySubnet` as explicit resources before deploying either service.

**Rejected because**: These subnets are already created by `networkingHub` module. The issue is the gateway/firewall attachment operations, not subnet creation.

## Related Changes

1. **deploy.ps1 v0.5**: Added `Remove-FaultedVpnGateway` function for cleanup
2. **deploy.ps1 v0.5**: Enhanced retry logic to detect `AnotherOperationInProgress` and `Conflict` errors
3. **deploy.ps1 v0.5**: Added progress indicators with estimated deployment times
4. **Remove-SmbLandingZone.ps1 v1.1**: Added VPN Gateway and orphaned PIP cleanup

## References

- [Bicep Modules - Resource Dependencies](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/modules#define-modules)
- [Common Azure Deployment Errors](https://learn.microsoft.com/en-us/azure/azure-resource-manager/troubleshooting/common-deployment-errors)
- [Azure Firewall Deployment Best Practices](https://learn.microsoft.com/en-us/azure/firewall/deploy-template)
