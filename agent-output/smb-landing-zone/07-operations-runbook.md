# Operations Runbook: SMB Landing Zone

> Generated by docs agent | 2026-02-02 | Artifact v0.1
> **Environment**: Production
> **Region**: swedencentral

---

## Quick Reference

| Item                | Value                                      |
| ------------------- | ------------------------------------------ |
| **Primary Region**  | swedencentral                              |
| **Resource Groups** | rg-hub, rg-spoke, rg-monitor, rg-backup, rg-migrate |
| **Support Contact** | Partner operations team                    |
| **Escalation Path** | L1 → L2 → Microsoft Support               |

### Critical Resources

| Resource              | Name                | Resource Group    | Criticality |
| --------------------- | ------------------- | ----------------- | ----------- |
| Azure Firewall        | fw-hub-slz-swc      | rg-hub-slz-swc    | High        |
| VPN Gateway           | vpng-hub-slz-swc    | rg-hub-slz-swc    | High        |
| Log Analytics         | log-smblz-slz-swc   | rg-monitor-slz-swc| Medium      |
| Recovery Vault        | rsv-smblz-slz-swc   | rg-backup-slz-swc | Medium      |

---

## 1. Daily Operations

### 1.1 Health Checks

**Morning Health Check (5 minutes):**

1. ✅ Verify Azure Service Health - no active incidents in swedencentral
2. ✅ Check Firewall status - running and healthy
3. ✅ Check VPN Gateway status - connected (if applicable)
4. ✅ Review Log Analytics ingestion - data flowing
5. ✅ Check budget alerts - no overspend notifications

**Azure Portal Quick Links:**

- [Service Health](https://portal.azure.com/#blade/Microsoft_Azure_Health/AzureHealthBrowseBlade)
- [Resource Health](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/resourceHealth)

**KQL Query - System Health Overview:**

```kusto
// Check recent errors across all resources
AzureDiagnostics
| where TimeGenerated > ago(24h)
| where Level == "Error"
| summarize ErrorCount = count() by ResourceType, Resource
| order by ErrorCount desc
| take 10
```

### 1.2 Log Review

**Priority Logs to Review:**

| Log Source           | Query Focus              | Action Threshold |
| -------------------- | ------------------------ | ---------------- |
| Azure Firewall       | Denied connections       | >100/hour        |
| NSG Flow Logs        | Unusual traffic patterns | Manual review    |
| Azure AD Sign-ins    | Failed sign-ins          | >10/hour         |
| Defender for Cloud   | Security alerts          | Any High/Critical|

**KQL Query - Firewall Denied Traffic:**

```kusto
AzureDiagnostics
| where Category == "AzureFirewallNetworkRule"
| where msg_s contains "Deny"
| where TimeGenerated > ago(1h)
| summarize DeniedCount = count() by bin(TimeGenerated, 5m), SourceIP = extract(@"(\d+\.\d+\.\d+\.\d+)", 1, msg_s)
| order by TimeGenerated desc
```

---

## 2. Incident Response

### 2.1 Severity Definitions

| Severity | Definition                                  | Response Time | Escalation   |
| -------- | ------------------------------------------- | ------------- | ------------ |
| P1       | Complete service outage, no workaround      | 15 minutes    | Immediate    |
| P2       | Major feature unavailable, workaround exists| 1 hour        | Within 2 hrs |
| P3       | Minor issue, service functional             | 4 hours       | Next day     |
| P4       | Cosmetic/documentation issue                | Best effort   | None         |

### 2.2 Runbooks by Alert

| Alert                          | Runbook                           | Owner      |
| ------------------------------ | --------------------------------- | ---------- |
| Azure Firewall Down            | [Firewall Recovery](#31-restart-azure-firewall) | Network   |
| VPN Gateway Disconnected       | [VPN Troubleshooting](#32-vpn-gateway-troubleshooting) | Network |
| High Log Ingestion             | [Log Analytics Throttling](#33-log-analytics-cap) | Platform |
| Budget Threshold Exceeded      | [Cost Review](#34-budget-alert-response) | Finance |
| Backup Job Failed              | [Backup Recovery](#35-backup-job-failure) | Platform |

### 2.3 Common Error Codes

| Error Code | Meaning | Resolution |
|------------|---------|------------|
| `AnotherOperationInProgress` | Resource locked by concurrent operation | Wait 5-10 min, retry |
| `InternalServerError` | Azure platform issue | Check Service Health, retry |
| `QuotaExceeded` | Subscription limit reached | Request quota increase |
| `ResourceNotFound` | Resource deleted or moved | Verify resource exists |

---

## 3. Common Procedures

### 3.1 Restart Azure Firewall

Azure Firewall cannot be restarted directly. To recover from issues:

```powershell
# Option 1: Force re-provisioning (5-10 min downtime)
$fw = Get-AzFirewall -Name "fw-hub-slz-swc" -ResourceGroupName "rg-hub-slz-swc"
Set-AzFirewall -AzureFirewall $fw

# Option 2: Stop and Start (10-15 min downtime)
$fw = Get-AzFirewall -Name "fw-hub-slz-swc" -ResourceGroupName "rg-hub-slz-swc"
$fw.Deallocate()
Set-AzFirewall -AzureFirewall $fw
# Wait for deallocation to complete
$fw.Allocate($vnet, $pip, $mgmtPip)
Set-AzFirewall -AzureFirewall $fw
```

### 3.2 VPN Gateway Troubleshooting

```powershell
# Check VPN Gateway status
Get-AzVirtualNetworkGateway -Name "vpng-hub-slz-swc" -ResourceGroupName "rg-hub-slz-swc"

# Check VPN connections
Get-AzVirtualNetworkGatewayConnection -ResourceGroupName "rg-hub-slz-swc"

# Reset VPN Gateway (15-30 min)
Reset-AzVirtualNetworkGateway -VirtualNetworkGateway (Get-AzVirtualNetworkGateway -Name "vpng-hub-slz-swc" -ResourceGroupName "rg-hub-slz-swc")
```

### 3.3 Log Analytics Cap

If daily cap is reached (500 MB):

```powershell
# Check current usage
$ws = Get-AzOperationalInsightsWorkspace -Name "log-smblz-slz-swc" -ResourceGroupName "rg-monitor-slz-swc"
$usage = Get-AzOperationalInsightsUsage -Workspace $ws
$usage | Format-Table

# Increase daily cap (requires cost approval)
Set-AzOperationalInsightsWorkspace -Name "log-smblz-slz-swc" -ResourceGroupName "rg-monitor-slz-swc" -DailyQuotaGb 1.0
```

### 3.4 Budget Alert Response

1. Review current spend in Cost Management
2. Identify top cost drivers (usually Firewall or VPN Gateway)
3. Options:
   - Accept overage if temporary
   - Scale down to lower scenario (firewall → baseline)
   - Adjust budget threshold

```powershell
# Check current budget
Get-AzConsumptionBudget -Name "budget-smb-lz-monthly"

# Update budget amount
Set-AzConsumptionBudget -Name "budget-smb-lz-monthly" -Amount 600
```

### 3.5 Backup Job Failure

```powershell
# Check backup job status
$vault = Get-AzRecoveryServicesVault -Name "rsv-smblz-slz-swc" -ResourceGroupName "rg-backup-slz-swc"
Set-AzRecoveryServicesVaultContext -Vault $vault
Get-AzRecoveryServicesBackupJob -Status Failed

# Retry failed backup
$container = Get-AzRecoveryServicesBackupContainer -ContainerType AzureVM
$item = Get-AzRecoveryServicesBackupItem -Container $container -WorkloadType AzureVM
Backup-AzRecoveryServicesBackupItem -Item $item
```

---

## 4. Maintenance Windows

### 4.1 Scheduled Maintenance

| Task                      | Frequency | Window           | Impact        |
| ------------------------- | --------- | ---------------- | ------------- |
| Azure Firewall updates    | Monthly   | Auto (Microsoft) | None          |
| VPN Gateway maintenance   | Quarterly | Auto (Microsoft) | Brief drops   |
| Policy compliance scan    | Daily     | 03:00 UTC        | None          |
| Backup jobs               | Daily     | 02:00 UTC        | None          |
| Log Analytics purge       | Daily     | Automatic        | None          |

### 4.2 Change Management

| Change Type             | Approval Required | Lead Time    |
| ----------------------- | ----------------- | ------------ |
| Policy modification     | Yes (Security)    | 48 hours     |
| Network rule change     | Yes (Network)     | 24 hours     |
| Scenario upgrade        | Yes (Finance)     | 24 hours     |
| Emergency hotfix        | Verbal (post-hoc) | Immediate    |

---

## 5. Contacts & Escalation

### 5.1 Internal Contacts

| Role                    | Team            | Contact        |
| ----------------------- | --------------- | -------------- |
| Platform Owner          | Partner Team    | {owner-email}  |
| Security Officer        | Partner Team    | {security-email}|
| Finance Approver        | Partner Team    | {finance-email}|

### 5.2 Microsoft Support

| Support Level | When to Engage | SLA |
|---------------|----------------|-----|
| Azure Support (Basic) | Service Health issues | Best effort |
| Azure Support (Standard) | P1/P2 incidents | 1 hour response |
| Premier Support | Complex issues | 15 min response |

**Create Support Request:**
[Azure Support](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade)

---

## 6. Change Log

| Date       | Version | Change                              | Author       |
| ---------- | ------- | ----------------------------------- | ------------ |
| 2026-02-02 | 0.1     | Initial runbook creation            | docs agent   |

---

_Operations runbook generated by docs agent for SMB Landing Zone v0.3.0._
