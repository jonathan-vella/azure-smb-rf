# Step 5: Implementation Reference - SMB Landing Zone

> Generated by bicep-code agent | 2026-01-28 | Artifact v0.1

## Bicep Templates Location

üìÅ **Code Location**: [`infra/bicep/smb-landing-zone/`](../../infra/bicep/smb-landing-zone/)

## File Structure

```
infra/bicep/smb-landing-zone/
‚îú‚îÄ‚îÄ main.bicep                          # Main orchestration template (subscription scope)
‚îú‚îÄ‚îÄ main.bicepparam                     # Parameter file with defaults
‚îú‚îÄ‚îÄ deploy.ps1                          # PowerShell deployment script
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ Remove-SmbLandingZonePolicies.ps1   # Policy cleanup script
‚îî‚îÄ‚îÄ modules/
    ‚îú‚îÄ‚îÄ policy-assignments.bicep        # 20 Azure Policy assignments
    ‚îú‚îÄ‚îÄ resource-groups.bicep           # 5 resource groups
    ‚îú‚îÄ‚îÄ networking-hub.bicep            # Hub VNet, Bastion, NSG, DNS
    ‚îú‚îÄ‚îÄ networking-spoke.bicep          # Spoke VNet, NAT Gateway, NSG
    ‚îú‚îÄ‚îÄ networking-peering.bicep        # VNet peering orchestration
    ‚îú‚îÄ‚îÄ networking-peering-spoke.bicep  # Spoke-to-hub peering helper
    ‚îú‚îÄ‚îÄ monitoring.bicep                # Log Analytics Workspace
    ‚îú‚îÄ‚îÄ backup.bicep                    # Recovery Services Vault
    ‚îú‚îÄ‚îÄ migrate.bicep                   # Azure Migrate Project
    ‚îú‚îÄ‚îÄ budget.bicep                    # Cost Management Budget
    ‚îú‚îÄ‚îÄ firewall.bicep                  # Azure Firewall Basic (optional)
    ‚îî‚îÄ‚îÄ vpn-gateway.bicep               # VPN Gateway (optional)
```

## Validation Status

| Check          | Status  | Notes                                                  |
| -------------- | ------- | ------------------------------------------------------ |
| `bicep build`  | ‚úÖ Pass | Template compiles successfully                         |
| `bicep lint`   | ‚ö†Ô∏è Pass | Minor warnings for conditional module outputs (BCP318) |
| `bicep format` | ‚úÖ Pass | All files formatted                                    |

### Known Warnings (Acceptable)

- **BCP318** on conditional module outputs - Expected behavior when accessing outputs from modules that may not be deployed
- **no-unused-params** on migrate.bicep `tags` - Azure Migrate API doesn't support tags, parameter kept for interface consistency

## Resources Created

### Subscription-Scope Resources

| Resource                | Bicep Type                                | Module                   |
| ----------------------- | ----------------------------------------- | ------------------------ |
| Policy Assignments (20) | Microsoft.Authorization/policyAssignments | policy-assignments.bicep |
| Cost Management Budget  | Microsoft.Consumption/budgets             | budget.bicep             |

### Resource Groups (5)

| Resource Group | Name Pattern              | Module                |
| -------------- | ------------------------- | --------------------- |
| Hub            | rg-hub-{env}-{region}     | resource-groups.bicep |
| Spoke          | rg-spoke-{env}-{region}   | resource-groups.bicep |
| Monitor        | rg-monitor-{env}-{region} | resource-groups.bicep |
| Backup         | rg-backup-{env}-{region}  | resource-groups.bicep |
| Migrate        | rg-migrate-{env}-{region} | resource-groups.bicep |

### Core Infrastructure

| Resource                | Bicep Type                               | Module                 |
| ----------------------- | ---------------------------------------- | ---------------------- |
| Hub VNet                | Microsoft.Network/virtualNetworks        | networking-hub.bicep   |
| Spoke VNet              | Microsoft.Network/virtualNetworks        | networking-spoke.bicep |
| Hub NSG                 | Microsoft.Network/networkSecurityGroups  | networking-hub.bicep   |
| Spoke NSG               | Microsoft.Network/networkSecurityGroups  | networking-spoke.bicep |
| Azure Bastion           | Microsoft.Network/bastionHosts           | networking-hub.bicep   |
| NAT Gateway             | Microsoft.Network/natGateways            | networking-spoke.bicep |
| NAT Gateway Public IP   | Microsoft.Network/publicIPAddresses      | networking-spoke.bicep |
| Private DNS Zone        | Microsoft.Network/privateDnsZones        | networking-hub.bicep   |
| Log Analytics           | Microsoft.OperationalInsights/workspaces | monitoring.bicep       |
| Recovery Services Vault | Microsoft.RecoveryServices/vaults        | backup.bicep           |
| Azure Migrate Project   | Microsoft.Migrate/migrateProjects        | migrate.bicep          |

### Optional Resources (When Enabled)

| Resource           | Bicep Type                               | Module             | Trigger             |
| ------------------ | ---------------------------------------- | ------------------ | ------------------- |
| Azure Firewall     | Microsoft.Network/azureFirewalls         | firewall.bicep     | `deployFirewall`    |
| Firewall Policy    | Microsoft.Network/firewallPolicies       | firewall.bicep     | `deployFirewall`    |
| Firewall Public IP | Microsoft.Network/publicIPAddresses      | firewall.bicep     | `deployFirewall`    |
| VPN Gateway        | Microsoft.Network/virtualNetworkGateways | vpn-gateway.bicep  | `deployVpnGateway`  |
| Gateway Public IP  | Microsoft.Network/publicIPAddresses      | vpn-gateway.bicep  | `deployVpnGateway`  |
| VNet Peering       | Microsoft.Network/virtualNetworkPeerings | networking-peering | Either Firewall/VPN |

## Deployment Instructions

### Quick Deploy

```powershell
cd infra/bicep/smb-landing-zone
./deploy.ps1 -Owner "partner-ops@contoso.com"
```

### Preview Changes (What-If)

```powershell
./deploy.ps1 -Owner "partner-ops@contoso.com" -WhatIf
```

### Custom Parameters

```powershell
./deploy.ps1 `
    -Environment "prod" `
    -Owner "partner-ops@contoso.com" `
    -Location "swedencentral" `
    -HubVnetAddressSpace "10.0.0.0/16" `
    -SpokeVnetAddressSpace "10.1.0.0/16" `
    -BudgetAmount 500 `
    -LogAnalyticsDailyCapMb 500
```

### With Optional Services

```powershell
# Deploy with Azure Firewall and VPN Gateway (VpnGw1AZ)
./deploy.ps1 `
    -Owner "partner-ops@contoso.com" `
    -DeployFirewall `
    -DeployVpnGateway
```

## Key Implementation Notes

### Unique Resource Naming

```bicep
// Generated at subscription level, passed to all modules
var uniqueSuffix = uniqueString(subscription().subscriptionId)

// Region abbreviations
var regionAbbreviations = {
  swedencentral: 'swc'
  germanywestcentral: 'gwc'
}
```

### Subnet Address Allocation

| Subnet              | CIDR | Purpose                    |
| ------------------- | ---- | -------------------------- |
| AzureBastionSubnet  | /26  | Azure Bastion (64 IPs)     |
| AzureFirewallSubnet | /26  | Azure Firewall (64 IPs)    |
| GatewaySubnet       | /27  | VPN Gateway (32 IPs)       |
| snet-management     | /24  | Management resources       |
| snet-workload       | /24  | Workload VMs (256 IPs)     |
| snet-data           | /24  | Data tier (256 IPs)        |
| snet-app            | /24  | Application tier (256 IPs) |

### Policy Assignments

20 Azure Policies deployed at subscription scope:

- **4 Compute**: VM SKU restrictions, no public IPs, managed disks, ARM VMs
- **4 Network**: NSG requirements, management ports, IP forwarding
- **5 Storage**: HTTPS, TLS 1.2, no public access, network restrictions
- **2 Identity**: SQL Azure AD-only auth, no public access
- **3 Governance**: Required tags (Environment, Owner), allowed locations
- **2 Operations**: VM backup, diagnostic settings

### Cost Controls

- **Budget**: $500/month default with 80%/90%/100% alerts
- **Log Analytics**: 500MB/day ingestion cap
- **Bastion**: Developer SKU (cost-optimized)
- **NAT Gateway**: Standard with 4-minute idle timeout
- **Recovery Vault**: LRS storage (locally redundant)

### Security Configuration

- All NSGs configured with deny-by-default (priority 4096)
- Bastion Developer SKU (no public IP required)
- Private DNS Zone with auto-registration
- NAT Gateway for secure outbound connectivity
- Soft delete enabled on Recovery Services Vault

## Policy Cleanup

To remove all SMB Landing Zone policies before redeployment or cleanup:

```powershell
./scripts/Remove-SmbLandingZonePolicies.ps1 -WhatIf  # Preview
./scripts/Remove-SmbLandingZonePolicies.ps1          # Execute
```

---

_Implementation reference generated from Bicep templates in `infra/bicep/smb-landing-zone/`._
