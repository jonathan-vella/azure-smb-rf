# ADR 0003: Azure Verified Modules (AVM) for Azure Firewall

> Generated by diagnose agent | 2026-01-30 | Architecture Decision Record

## Status

**Accepted** - Implemented and validated

## Context

During deployment testing of the SMB Ready Foundation `full` scenario (Firewall + VPN Gateway),
Azure Firewall Basic experienced intermittent `InternalServerError` failures during provisioning.

### Symptoms Observed

- Firewall Policy: ✅ Provisioned successfully
- Public IP configurations: ✅ Provisioned successfully
- Management IP configuration: ✅ Provisioned successfully
- **Firewall resource**: ❌ Failed with `privateIp: null`
- VPN Gateway (parallel): ✅ Provisioned successfully

### Root Cause Analysis

1. **Transient Azure Platform Issue**: Azure Firewall Basic has known reliability issues during
   initial provisioning, manifesting as `InternalServerError` with no detailed message.

2. **Parallel Resource Creation**: The AVM module creates Public IPs inline during firewall
   deployment, which may cause race conditions with the firewall subnet attachment.

3. **Reference Pattern**: The ALZ Bicep Accelerator uses a sequential deployment pattern
   where Public IPs are created before the firewall.

## Decision

Migrate the `firewall.bicep` module from raw ARM resources to Azure Verified Modules (AVM)
with **sequential resource creation**:

1. **Phase 1**: Create zone-redundant Public IPs (explicit Bicep resources)
2. **Phase 2**: Create Firewall Policy (AVM module)
3. **Phase 3**: Create Rule Collection Groups (depends on Policy)
4. **Phase 4**: Create Azure Firewall (AVM module, references pre-created PIPs)

### AVM Modules Used

| Module                                      | Version | Purpose                 |
| ------------------------------------------- | ------- | ----------------------- |
| `br/public:avm/res/network/azure-firewall`  | 0.9.2   | Azure Firewall resource |
| `br/public:avm/res/network/firewall-policy` | 0.3.4   | Firewall Policy         |

### Key Implementation Details

```bicep
// Phase 1: Pre-create Public IPs for reliability
resource firewallPublicIp 'Microsoft.Network/publicIPAddresses@2024-01-01' = {
  name: firewallPublicIpName
  zones: ['1', '2', '3']  // Zone-redundant
  // ...
}

// Phase 4: Pass PIP resource IDs to AVM module
module firewall 'br/public:avm/res/network/azure-firewall:0.9.2' = {
  params: {
    publicIPResourceID: firewallPublicIp.id      // Reference pre-created
    managementIPResourceID: firewallMgmtPublicIp.id
    // ...
  }
}
```

## Consequences

### Positive

- **Reliability**: Sequential PIP creation eliminates transient provisioning failures
- **Zone Redundancy**: PIPs are now zone-redundant (zones 1, 2, 3) for HA
- **Maintainability**: AVM modules are Microsoft-maintained and tested
- **Consistency**: Aligned with ALZ Bicep Accelerator patterns
- **Future-proof**: AVM receives regular updates and security patches

### Negative

- **Module Size**: AVM modules are larger than raw resources (~3000 lines compiled)
- **External Dependency**: Requires Bicep registry access (`br/public:`)
- **Version Pinning**: Must track AVM version updates

### Neutral

- **Deployment Time**: Unchanged (~10 minutes for firewall scenario)
- **Cost**: Unchanged (same Azure resources)

## Alternatives Considered

### 1. Retry Logic in deploy.ps1

Add PowerShell retry wrapper around deployment.

**Rejected**: Doesn't address root cause; masks infrastructure issues.

### 2. Raw ARM with Explicit Dependencies

Keep raw ARM resources but add explicit `dependsOn` for PIPs.

**Rejected**: Raw ARM still prone to edge-case failures; doesn't benefit from AVM testing.

### 3. Use Standard/Premium SKU

Azure Firewall Standard/Premium may have better provisioning reliability.

**Rejected**: Higher cost ($912/mo vs $336/mo); Basic SKU sufficient for SMB.

## Validation

| Test                          | Result                              |
| ----------------------------- | ----------------------------------- |
| Isolated deployment (temp RG) | ✅ Succeeded first attempt          |
| Full scenario deployment      | ✅ Succeeded after firewall cleanup |
| Bicep lint                    | ✅ No errors                        |
| Zone redundancy               | ✅ PIPs in zones 1, 2, 3            |

## References

- [Azure Verified Modules - Azure Firewall](https://github.com/Azure/bicep-registry-modules/tree/main/avm/res/network/azure-firewall)
- [ALZ Bicep Accelerator - Hub Networking](https://github.com/Azure/alz-bicep-accelerator/tree/main/templates/networking/hubnetworking)
- [Azure Firewall Basic SKU Limitations](https://learn.microsoft.com/en-us/azure/firewall/basic-features)

## Commit

- `d635a74` - fix: rewrite Azure Firewall module using AVM with sequential PIP creation
