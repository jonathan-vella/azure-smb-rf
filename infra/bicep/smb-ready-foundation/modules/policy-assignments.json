{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "13386646691436577292"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Location for policy assignment metadata"
      }
    },
    "allowedLocations": {
      "type": "array",
      "defaultValue": [
        "swedencentral",
        "germanywestcentral",
        "global"
      ],
      "metadata": {
        "description": "Allowed Azure regions for resources"
      }
    },
    "allowedVmSkus": {
      "type": "array",
      "defaultValue": [
        "Standard_B1ls",
        "Standard_B1s",
        "Standard_B1ms",
        "Standard_B2s",
        "Standard_B2ms",
        "Standard_B2ls_v2",
        "Standard_B2s_v2",
        "Standard_B2ms_v2",
        "Standard_B4ms",
        "Standard_B4ls_v2",
        "Standard_B4s_v2",
        "Standard_B4ms_v2",
        "Standard_B8ms",
        "Standard_B8ls_v2",
        "Standard_B8s_v2",
        "Standard_B8ms_v2",
        "Standard_D2s_v5",
        "Standard_D4s_v5",
        "Standard_D8s_v5",
        "Standard_D16s_v5",
        "Standard_D2ds_v5",
        "Standard_D4ds_v5",
        "Standard_D8ds_v5",
        "Standard_D2s_v6",
        "Standard_D4s_v6",
        "Standard_D8s_v6",
        "Standard_E2s_v5",
        "Standard_E4s_v5",
        "Standard_E8s_v5",
        "Standard_E2ds_v5",
        "Standard_E4ds_v5",
        "Standard_E2s_v6",
        "Standard_E4s_v6"
      ],
      "metadata": {
        "description": "Allowed VM SKUs (B-series and D/E v5/v6 series)"
      }
    }
  },
  "variables": {
    "policyDefinitions": {
      "allowedVmSkus": "/providers/Microsoft.Authorization/policyDefinitions/cccc23c7-8427-4f53-ad12-b6a63eb452b3",
      "noPublicIpOnNic": "/providers/Microsoft.Authorization/policyDefinitions/83a86a26-fd1f-447c-b59d-e51f44264114",
      "auditManagedDisks": "/providers/Microsoft.Authorization/policyDefinitions/06a78e20-9358-41c9-923c-fb736d382a4d",
      "auditArmVms": "/providers/Microsoft.Authorization/policyDefinitions/1d84d5fb-01f6-4d12-ba4f-4a26081d403d",
      "nsgOnSubnets": "/providers/Microsoft.Authorization/policyDefinitions/e71308d3-144b-4262-b144-efdc3cc90517",
      "closeManagementPorts": "/providers/Microsoft.Authorization/policyDefinitions/22730e10-96f6-4aac-ad84-9383d35b5917",
      "restrictNsgPorts": "/providers/Microsoft.Authorization/policyDefinitions/9daedab3-fb2d-461e-b861-71790eead4f6",
      "disableIpForwarding": "/providers/Microsoft.Authorization/policyDefinitions/88c0b9da-ce96-4b03-9635-f29a937e2900",
      "storageHttpsOnly": "/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9",
      "noPublicBlobAccess": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
      "storageTls12": "/providers/Microsoft.Authorization/policyDefinitions/fe83a0eb-a853-422d-aac2-1bffd182c5d0",
      "restrictStorageNetwork": "/providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c",
      "storageArmMigration": "/providers/Microsoft.Authorization/policyDefinitions/37e0d2fe-28a5-43d6-a273-67d37d1f5606",
      "sqlAzureAdOnly": "/providers/Microsoft.Authorization/policyDefinitions/b3a22bc9-66de-45fb-98fa-00f5df42f41a",
      "sqlNoPublicAccess": "/providers/Microsoft.Authorization/policyDefinitions/1b8ca024-1d5c-4dec-8995-b1a932b41780",
      "requireTag": "/providers/Microsoft.Authorization/policyDefinitions/871b6d14-10aa-478d-b590-94f262ecfa99",
      "allowedLocations": "/providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c",
      "vmBackupRequired": "/providers/Microsoft.Authorization/policyDefinitions/013e242c-8828-4970-87b3-ab247555486d",
      "diagnosticSettings": "/providers/Microsoft.Authorization/policyDefinitions/7f89b1eb-583c-429a-8828-af049802c1d9"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-compute-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Allowed VM SKUs",
        "description": "Restrict VM deployments to cost-effective B-series and D/E v5/v6 series SKUs",
        "policyDefinitionId": "[variables('policyDefinitions').allowedVmSkus]",
        "enforcementMode": "Default",
        "parameters": {
          "listOfAllowedSKUs": {
            "value": "[parameters('allowedVmSkus')]"
          }
        }
      },
      "metadata": {
        "description": "Restrict VM SKUs to B-series and D/E v5/v6 series"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-compute-02",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: No Public IPs on NICs",
        "description": "Prevent VMs from having public IP addresses for security",
        "policyDefinitionId": "[variables('policyDefinitions').noPublicIpOnNic]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Deny public IP addresses on VM network interfaces"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-compute-03",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Audit Managed Disks",
        "description": "Audit VMs that do not use managed disks",
        "policyDefinitionId": "[variables('policyDefinitions').auditManagedDisks]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit VMs not using managed disks"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-compute-04",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Audit ARM VMs",
        "description": "Audit VMs created using classic deployment model",
        "policyDefinitionId": "[variables('policyDefinitions').auditArmVms]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit VMs not deployed via ARM"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-network-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: NSG on Subnets",
        "description": "Audit subnets that do not have a Network Security Group",
        "policyDefinitionId": "[variables('policyDefinitions').nsgOnSubnets]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit subnets without NSG"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-network-02",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Close Management Ports",
        "description": "Audit VMs with management ports (22, 3389) exposed to the internet",
        "policyDefinitionId": "[variables('policyDefinitions').closeManagementPorts]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit VMs with management ports exposed to internet"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-network-03",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Restrict NSG Ports",
        "description": "Audit NSG rules that allow unrestricted access",
        "policyDefinitionId": "[variables('policyDefinitions').restrictNsgPorts]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit NSG rules with unrestricted ports"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-network-04",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Disable IP Forwarding",
        "description": "Deny enabling IP forwarding on network interfaces",
        "policyDefinitionId": "[variables('policyDefinitions').disableIpForwarding]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Deny IP forwarding on VM network interfaces"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-storage-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Storage HTTPS Only",
        "description": "Deny storage accounts that do not require HTTPS",
        "policyDefinitionId": "[variables('policyDefinitions').storageHttpsOnly]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Deny storage accounts without HTTPS"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-storage-02",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: No Public Blob Access",
        "description": "Deny public blob access on storage accounts",
        "policyDefinitionId": "[variables('policyDefinitions').noPublicBlobAccess]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Deny public blob access on storage accounts"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-storage-03",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Storage TLS 1.2",
        "description": "Deny storage accounts with minimum TLS version below 1.2",
        "policyDefinitionId": "[variables('policyDefinitions').storageTls12]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Deny storage accounts with TLS version below 1.2"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-storage-04",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Restrict Storage Network",
        "description": "Audit storage accounts with unrestricted network access",
        "policyDefinitionId": "[variables('policyDefinitions').restrictStorageNetwork]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit storage accounts with unrestricted network access"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-storage-05",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Storage ARM Migration",
        "description": "Audit classic storage accounts that should be migrated to ARM",
        "policyDefinitionId": "[variables('policyDefinitions').storageArmMigration]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit storage accounts not migrated to ARM"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-identity-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: SQL Azure AD Only",
        "description": "Audit SQL servers that do not use Azure AD-only authentication",
        "policyDefinitionId": "[variables('policyDefinitions').sqlAzureAdOnly]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit SQL servers without Azure AD-only authentication"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-identity-02",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: SQL No Public Access",
        "description": "Audit SQL servers with public network access enabled",
        "policyDefinitionId": "[variables('policyDefinitions').sqlNoPublicAccess]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit SQL servers with public network access"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-tagging-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Require Environment Tag",
        "description": "Deny resource creation without Environment tag",
        "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
        "enforcementMode": "Default",
        "parameters": {
          "tagName": {
            "value": "Environment"
          }
        }
      },
      "metadata": {
        "description": "Deny resources without Environment tag"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-tagging-02",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Require Owner Tag",
        "description": "Deny resource creation without Owner tag",
        "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
        "enforcementMode": "Default",
        "parameters": {
          "tagName": {
            "value": "Owner"
          }
        }
      },
      "metadata": {
        "description": "Deny resources without Owner tag"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-governance-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Allowed Locations",
        "description": "Restrict resource deployment to swedencentral, germanywestcentral, and global",
        "policyDefinitionId": "[variables('policyDefinitions').allowedLocations]",
        "enforcementMode": "Default",
        "parameters": {
          "listOfAllowedLocations": {
            "value": "[parameters('allowedLocations')]"
          }
        }
      },
      "metadata": {
        "description": "Restrict resource deployment to allowed regions"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-backup-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: VM Backup Required",
        "description": "Audit VMs that do not have backup configured",
        "policyDefinitionId": "[variables('policyDefinitions').vmBackupRequired]",
        "enforcementMode": "Default"
      },
      "metadata": {
        "description": "Audit VMs without backup configured"
      }
    },
    {
      "type": "Microsoft.Authorization/policyAssignments",
      "apiVersion": "2024-04-01",
      "name": "smb-monitoring-01",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "SMB LZ: Diagnostic Settings Required",
        "description": "Audit resources that do not have diagnostic settings configured",
        "policyDefinitionId": "[variables('policyDefinitions').diagnosticSettings]",
        "enforcementMode": "Default",
        "parameters": {
          "listOfResourceTypes": {
            "value": [
              "Microsoft.Compute/virtualMachines",
              "Microsoft.Network/virtualNetworks",
              "Microsoft.Network/networkSecurityGroups",
              "Microsoft.Network/azureFirewalls",
              "Microsoft.Network/bastionHosts",
              "Microsoft.KeyVault/vaults",
              "Microsoft.RecoveryServices/vaults",
              "Microsoft.Sql/servers"
            ]
          }
        }
      },
      "metadata": {
        "description": "Audit resources without diagnostic settings"
      }
    }
  ],
  "outputs": {
    "policyAssignmentNames": {
      "type": "array",
      "metadata": {
        "description": "List of policy assignment names for reference"
      },
      "value": [
        "smb-compute-01",
        "smb-compute-02",
        "smb-compute-03",
        "smb-compute-04",
        "smb-network-01",
        "smb-network-02",
        "smb-network-03",
        "smb-network-04",
        "smb-storage-01",
        "smb-storage-02",
        "smb-storage-03",
        "smb-storage-04",
        "smb-storage-05",
        "smb-identity-01",
        "smb-identity-02",
        "smb-tagging-01",
        "smb-tagging-02",
        "smb-governance-01",
        "smb-backup-01",
        "smb-monitoring-01"
      ]
    },
    "policyCount": {
      "type": "int",
      "metadata": {
        "description": "Total number of policy assignments (excludes auto-backup policy deployed separately)"
      },
      "value": 20
    }
  }
}