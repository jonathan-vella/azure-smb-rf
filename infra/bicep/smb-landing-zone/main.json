{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "13259995623128367711"
    }
  },
  "parameters": {
    "scenario": {
      "type": "string",
      "defaultValue": "baseline",
      "allowedValues": [
        "baseline",
        "firewall",
        "vpn",
        "full"
      ],
      "metadata": {
        "description": "Deployment scenario preset (determines which optional services are deployed)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "allowedValues": [
        "swedencentral",
        "germanywestcentral"
      ],
      "metadata": {
        "description": "Primary deployment region"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name for resource naming and tagging"
      }
    },
    "owner": {
      "type": "string",
      "metadata": {
        "description": "Owner email or team name (required for tagging)"
      }
    },
    "hubVnetAddressSpace": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Hub VNet address space CIDR"
      }
    },
    "spokeVnetAddressSpace": {
      "type": "string",
      "defaultValue": "10.1.0.0/16",
      "metadata": {
        "description": "Spoke VNet address space CIDR"
      }
    },
    "onPremisesAddressSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "On-premises network address space CIDR (for VPN routing)"
      }
    },
    "logAnalyticsDailyCapGb": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "Log Analytics daily ingestion cap in GB (decimal, e.g. 0.5 for ~500MB)"
      }
    },
    "budgetAmount": {
      "type": "int",
      "defaultValue": 500,
      "minValue": 100,
      "maxValue": 10000,
      "metadata": {
        "description": "Monthly budget amount in USD"
      }
    },
    "budgetAlertEmail": {
      "type": "string",
      "defaultValue": "[parameters('owner')]",
      "metadata": {
        "description": "Budget alert email address"
      }
    },
    "deploymentTimestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-01')]",
      "metadata": {
        "description": "Deployment timestamp for budget start date"
      }
    }
  },
  "variables": {
    "deployFirewall": "[or(equals(parameters('scenario'), 'firewall'), equals(parameters('scenario'), 'full'))]",
    "deployVpnGateway": "[or(equals(parameters('scenario'), 'vpn'), equals(parameters('scenario'), 'full'))]",
    "uniqueSuffix": "[uniqueString(subscription().subscriptionId)]",
    "regionAbbreviations": {
      "swedencentral": "swc",
      "germanywestcentral": "gwc"
    },
    "regionShort": "[variables('regionAbbreviations')[parameters('location')]]",
    "deployPeering": "[or(variables('deployFirewall'), variables('deployVpnGateway'))]",
    "deploySpokeNatGateway": "[not(variables('deployFirewall'))]",
    "sharedServicesTags": {
      "Environment": "slz",
      "Owner": "[parameters('owner')]",
      "Project": "smb-landing-zone",
      "ManagedBy": "Bicep"
    },
    "spokeTags": {
      "Environment": "[parameters('environment')]",
      "Owner": "[parameters('owner')]",
      "Project": "smb-landing-zone",
      "ManagedBy": "Bicep"
    },
    "rgNames": {
      "hub": "[format('rg-hub-slz-{0}', variables('regionShort'))]",
      "spoke": "[format('rg-spoke-{0}-{1}', parameters('environment'), variables('regionShort'))]",
      "monitor": "[format('rg-monitor-slz-{0}', variables('regionShort'))]",
      "backup": "[format('rg-backup-slz-{0}', variables('regionShort'))]",
      "migrate": "[format('rg-migrate-slz-{0}', variables('regionShort'))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('policy-assignments-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14525703166816057413"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "swedencentral",
              "metadata": {
                "description": "Location for policy assignment metadata"
              }
            },
            "allowedLocations": {
              "type": "array",
              "defaultValue": [
                "swedencentral",
                "germanywestcentral",
                "global"
              ],
              "metadata": {
                "description": "Allowed Azure regions for resources"
              }
            },
            "allowedVmSkus": {
              "type": "array",
              "defaultValue": [
                "Standard_B1ls",
                "Standard_B1s",
                "Standard_B1ms",
                "Standard_B2s",
                "Standard_B2ms",
                "Standard_B2ls_v2",
                "Standard_B2s_v2",
                "Standard_B2ms_v2",
                "Standard_B4ms",
                "Standard_B4ls_v2",
                "Standard_B4s_v2",
                "Standard_B4ms_v2",
                "Standard_B8ms",
                "Standard_B8ls_v2",
                "Standard_B8s_v2",
                "Standard_B8ms_v2",
                "Standard_D2s_v5",
                "Standard_D4s_v5",
                "Standard_D8s_v5",
                "Standard_D16s_v5",
                "Standard_D2ds_v5",
                "Standard_D4ds_v5",
                "Standard_D8ds_v5",
                "Standard_D2s_v6",
                "Standard_D4s_v6",
                "Standard_D8s_v6",
                "Standard_E2s_v5",
                "Standard_E4s_v5",
                "Standard_E8s_v5",
                "Standard_E2ds_v5",
                "Standard_E4ds_v5",
                "Standard_E2s_v6",
                "Standard_E4s_v6"
              ],
              "metadata": {
                "description": "Allowed VM SKUs (B-series and D/E v5/v6 series)"
              }
            }
          },
          "variables": {
            "policyDefinitions": {
              "allowedVmSkus": "/providers/Microsoft.Authorization/policyDefinitions/cccc23c7-8427-4f53-ad12-b6a63eb452b3",
              "noPublicIpOnNic": "/providers/Microsoft.Authorization/policyDefinitions/83a86a26-fd1f-447c-b59d-e51f44264114",
              "auditManagedDisks": "/providers/Microsoft.Authorization/policyDefinitions/06a78e20-9358-41c9-923c-fb736d382a4d",
              "auditArmVms": "/providers/Microsoft.Authorization/policyDefinitions/1d84d5fb-01f6-4d12-ba4f-4a26081d403d",
              "nsgOnSubnets": "/providers/Microsoft.Authorization/policyDefinitions/e71308d3-144b-4262-b144-efdc3cc90517",
              "closeManagementPorts": "/providers/Microsoft.Authorization/policyDefinitions/22730e10-96f6-4aac-ad84-9383d35b5917",
              "restrictNsgPorts": "/providers/Microsoft.Authorization/policyDefinitions/9daedab3-fb2d-461e-b861-71790eead4f6",
              "disableIpForwarding": "/providers/Microsoft.Authorization/policyDefinitions/88c0b9da-ce96-4b03-9635-f29a937e2900",
              "storageHttpsOnly": "/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9",
              "noPublicBlobAccess": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
              "storageTls12": "/providers/Microsoft.Authorization/policyDefinitions/fe83a0eb-a853-422d-aac2-1bffd182c5d0",
              "restrictStorageNetwork": "/providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c",
              "storageArmMigration": "/providers/Microsoft.Authorization/policyDefinitions/37e0d2fe-28a5-43d6-a273-67d37d1f5606",
              "sqlAzureAdOnly": "/providers/Microsoft.Authorization/policyDefinitions/b3a22bc9-66de-45fb-98fa-00f5df42f41a",
              "sqlNoPublicAccess": "/providers/Microsoft.Authorization/policyDefinitions/1b8ca024-1d5c-4dec-8995-b1a932b41780",
              "requireTag": "/providers/Microsoft.Authorization/policyDefinitions/871b6d14-10aa-478d-b590-94f262ecfa99",
              "allowedLocations": "/providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c",
              "vmBackupRequired": "/providers/Microsoft.Authorization/policyDefinitions/013e242c-8828-4970-87b3-ab247555486d",
              "diagnosticSettings": "/providers/Microsoft.Authorization/policyDefinitions/7f89b1eb-583c-429a-8828-af049802c1d9"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Allowed VM SKUs",
                "description": "Restrict VM deployments to cost-effective B-series and D/E v5/v6 series SKUs",
                "policyDefinitionId": "[variables('policyDefinitions').allowedVmSkus]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfAllowedSKUs": {
                    "value": "[parameters('allowedVmSkus')]"
                  }
                }
              },
              "metadata": {
                "description": "Restrict VM SKUs to B-series and D/E v5/v6 series"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: No Public IPs on NICs",
                "description": "Prevent VMs from having public IP addresses for security",
                "policyDefinitionId": "[variables('policyDefinitions').noPublicIpOnNic]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny public IP addresses on VM network interfaces"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Audit Managed Disks",
                "description": "Audit VMs that do not use managed disks",
                "policyDefinitionId": "[variables('policyDefinitions').auditManagedDisks]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs not using managed disks"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Audit ARM VMs",
                "description": "Audit VMs created using classic deployment model",
                "policyDefinitionId": "[variables('policyDefinitions').auditArmVms]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs not deployed via ARM"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: NSG on Subnets",
                "description": "Audit subnets that do not have a Network Security Group",
                "policyDefinitionId": "[variables('policyDefinitions').nsgOnSubnets]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit subnets without NSG"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Close Management Ports",
                "description": "Audit VMs with management ports (22, 3389) exposed to the internet",
                "policyDefinitionId": "[variables('policyDefinitions').closeManagementPorts]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs with management ports exposed to internet"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Restrict NSG Ports",
                "description": "Audit NSG rules that allow unrestricted access",
                "policyDefinitionId": "[variables('policyDefinitions').restrictNsgPorts]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit NSG rules with unrestricted ports"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Disable IP Forwarding",
                "description": "Deny enabling IP forwarding on network interfaces",
                "policyDefinitionId": "[variables('policyDefinitions').disableIpForwarding]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny IP forwarding on VM network interfaces"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage HTTPS Only",
                "description": "Deny storage accounts that do not require HTTPS",
                "policyDefinitionId": "[variables('policyDefinitions').storageHttpsOnly]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny storage accounts without HTTPS"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: No Public Blob Access",
                "description": "Deny public blob access on storage accounts",
                "policyDefinitionId": "[variables('policyDefinitions').noPublicBlobAccess]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny public blob access on storage accounts"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage TLS 1.2",
                "description": "Deny storage accounts with minimum TLS version below 1.2",
                "policyDefinitionId": "[variables('policyDefinitions').storageTls12]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny storage accounts with TLS version below 1.2"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Restrict Storage Network",
                "description": "Audit storage accounts with unrestricted network access",
                "policyDefinitionId": "[variables('policyDefinitions').restrictStorageNetwork]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit storage accounts with unrestricted network access"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-05",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage ARM Migration",
                "description": "Audit classic storage accounts that should be migrated to ARM",
                "policyDefinitionId": "[variables('policyDefinitions').storageArmMigration]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit storage accounts not migrated to ARM"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-identity-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: SQL Azure AD Only",
                "description": "Audit SQL servers that do not use Azure AD-only authentication",
                "policyDefinitionId": "[variables('policyDefinitions').sqlAzureAdOnly]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit SQL servers without Azure AD-only authentication"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-identity-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: SQL No Public Access",
                "description": "Audit SQL servers with public network access enabled",
                "policyDefinitionId": "[variables('policyDefinitions').sqlNoPublicAccess]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit SQL servers with public network access"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-tagging-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Require Environment Tag",
                "description": "Deny resource creation without Environment tag",
                "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
                "enforcementMode": "Default",
                "parameters": {
                  "tagName": {
                    "value": "Environment"
                  }
                }
              },
              "metadata": {
                "description": "Deny resources without Environment tag"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-tagging-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Require Owner Tag",
                "description": "Deny resource creation without Owner tag",
                "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
                "enforcementMode": "Default",
                "parameters": {
                  "tagName": {
                    "value": "Owner"
                  }
                }
              },
              "metadata": {
                "description": "Deny resources without Owner tag"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-governance-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Allowed Locations",
                "description": "Restrict resource deployment to swedencentral, germanywestcentral, and global",
                "policyDefinitionId": "[variables('policyDefinitions').allowedLocations]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfAllowedLocations": {
                    "value": "[parameters('allowedLocations')]"
                  }
                }
              },
              "metadata": {
                "description": "Restrict resource deployment to allowed regions"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-backup-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: VM Backup Required",
                "description": "Audit VMs that do not have backup configured",
                "policyDefinitionId": "[variables('policyDefinitions').vmBackupRequired]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs without backup configured"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-monitoring-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Diagnostic Settings Required",
                "description": "Audit resources that do not have diagnostic settings configured",
                "policyDefinitionId": "[variables('policyDefinitions').diagnosticSettings]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfResourceTypes": {
                    "value": [
                      "Microsoft.Compute/virtualMachines",
                      "Microsoft.Network/virtualNetworks",
                      "Microsoft.Network/networkSecurityGroups",
                      "Microsoft.Network/azureFirewalls",
                      "Microsoft.Network/bastionHosts",
                      "Microsoft.KeyVault/vaults",
                      "Microsoft.RecoveryServices/vaults",
                      "Microsoft.Sql/servers"
                    ]
                  }
                }
              },
              "metadata": {
                "description": "Audit resources without diagnostic settings"
              }
            }
          ],
          "outputs": {
            "policyAssignmentNames": {
              "type": "array",
              "metadata": {
                "description": "List of policy assignment names for reference"
              },
              "value": [
                "smb-lz-compute-01",
                "smb-lz-compute-02",
                "smb-lz-compute-03",
                "smb-lz-compute-04",
                "smb-lz-network-01",
                "smb-lz-network-02",
                "smb-lz-network-03",
                "smb-lz-network-04",
                "smb-lz-storage-01",
                "smb-lz-storage-02",
                "smb-lz-storage-03",
                "smb-lz-storage-04",
                "smb-lz-storage-05",
                "smb-lz-identity-01",
                "smb-lz-identity-02",
                "smb-lz-tagging-01",
                "smb-lz-tagging-02",
                "smb-lz-governance-01",
                "smb-lz-backup-01",
                "smb-lz-monitoring-01"
              ]
            },
            "policyCount": {
              "type": "int",
              "metadata": {
                "description": "Total number of policy assignments"
              },
              "value": 20
            }
          }
        }
      },
      "metadata": {
        "description": "Deploy 20 Azure Policy assignments at subscription scope"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('budget-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "budgetAmount": {
            "value": "[parameters('budgetAmount')]"
          },
          "alertEmail": {
            "value": "[parameters('budgetAlertEmail')]"
          },
          "startDate": {
            "value": "[parameters('deploymentTimestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9983972408414509734"
            }
          },
          "parameters": {
            "budgetAmount": {
              "type": "int",
              "defaultValue": 500,
              "minValue": 100,
              "maxValue": 10000,
              "metadata": {
                "description": "Monthly budget amount in USD"
              }
            },
            "alertEmail": {
              "type": "string",
              "metadata": {
                "description": "Email address for budget alerts"
              }
            },
            "startDate": {
              "type": "string",
              "metadata": {
                "description": "Budget start date (first day of month, format: yyyy-MM-dd)"
              }
            }
          },
          "variables": {
            "budgetName": "budget-smb-lz-monthly",
            "budgetStartDate": "[format('{0}01', substring(parameters('startDate'), 0, 8))]"
          },
          "resources": [
            {
              "type": "Microsoft.Consumption/budgets",
              "apiVersion": "2023-11-01",
              "name": "[variables('budgetName')]",
              "properties": {
                "category": "Cost",
                "amount": "[parameters('budgetAmount')]",
                "timeGrain": "Monthly",
                "timePeriod": {
                  "startDate": "[variables('budgetStartDate')]"
                },
                "notifications": {
                  "forecastAlert80": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 80,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Forecasted",
                    "locale": "en-us"
                  },
                  "actualAlert90": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 90,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Actual",
                    "locale": "en-us"
                  },
                  "actualAlert100": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 100,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Actual",
                    "locale": "en-us"
                  }
                }
              },
              "metadata": {
                "description": "Monthly budget with 80% forecast and 100% actual alerts"
              }
            }
          ],
          "outputs": {
            "budgetId": {
              "type": "string",
              "metadata": {
                "description": "Budget resource ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Consumption/budgets', variables('budgetName'))]"
            },
            "budgetName": {
              "type": "string",
              "metadata": {
                "description": "Budget name"
              },
              "value": "[variables('budgetName')]"
            }
          }
        }
      },
      "metadata": {
        "description": "Deploy Cost Management budget with alerts"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('resource-groups-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "sharedServicesTags": {
            "value": "[variables('sharedServicesTags')]"
          },
          "spokeTags": {
            "value": "[variables('spokeTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6636876391667713221"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource group deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod"
              ],
              "metadata": {
                "description": "Environment name for spoke resources"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "sharedServicesTags": {
              "type": "object",
              "metadata": {
                "description": "Tags for shared services resource groups (Environment = slz)"
              }
            },
            "spokeTags": {
              "type": "object",
              "metadata": {
                "description": "Tags for spoke resource group (Environment = dev/staging/prod)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-hub-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Hub resource group - VNet, Bastion, Firewall, VPN Gateway"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-monitor-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Monitoring resource group - Log Analytics"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-backup-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Backup resource group - Recovery Services Vault"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-migrate-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Migration resource group - Azure Migrate Project"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('spokeTags')]",
              "metadata": {
                "description": "Spoke resource group - Workload VNet, NAT Gateway"
              }
            }
          ],
          "outputs": {
            "hubResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Hub resource group name"
              },
              "value": "[format('rg-hub-slz-{0}', parameters('regionShort'))]"
            },
            "hubResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Hub resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-hub-slz-{0}', parameters('regionShort')))]"
            },
            "spokeResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group name"
              },
              "value": "[format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
            },
            "spokeResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort')))]"
            },
            "monitorResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Monitor resource group name"
              },
              "value": "[format('rg-monitor-slz-{0}', parameters('regionShort'))]"
            },
            "monitorResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Monitor resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-monitor-slz-{0}', parameters('regionShort')))]"
            },
            "backupResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Backup resource group name"
              },
              "value": "[format('rg-backup-slz-{0}', parameters('regionShort'))]"
            },
            "backupResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Backup resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-backup-slz-{0}', parameters('regionShort')))]"
            },
            "migrateResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Migrate resource group name"
              },
              "value": "[format('rg-migrate-slz-{0}', parameters('regionShort'))]"
            },
            "migrateResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Migrate resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-migrate-slz-{0}', parameters('regionShort')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('policy-assignments-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Create 5 resource groups for landing zone workloads"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-hub-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('hubVnetAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7954595598167331020"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet address space CIDR"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "nsgName": "[format('nsg-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "privateDnsZoneName": "privatelink.azure.com",
            "firewallSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 0)]",
            "firewallMgmtSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 1)]",
            "managementSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 2)]",
            "gatewaySubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 27, 6)]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Default deny all inbound traffic"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Hub NSG with default deny inbound rules"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "AzureFirewallSubnet",
                    "properties": {
                      "addressPrefix": "[variables('firewallSubnetPrefix')]"
                    }
                  },
                  {
                    "name": "AzureFirewallManagementSubnet",
                    "properties": {
                      "addressPrefix": "[variables('firewallMgmtSubnetPrefix')]"
                    }
                  },
                  {
                    "name": "GatewaySubnet",
                    "properties": {
                      "addressPrefix": "[variables('gatewaySubnetPrefix')]"
                    }
                  },
                  {
                    "name": "snet-management",
                    "properties": {
                      "addressPrefix": "[variables('managementSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ],
              "metadata": {
                "description": "Hub VNet with reserved subnets for Firewall, Firewall Management, and Gateway"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {},
              "metadata": {
                "description": "Private DNS Zone for Azure Private Link endpoints"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('link-{0}', variables('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                },
                "registrationEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ],
              "metadata": {
                "description": "Link Private DNS Zone to Hub VNet"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet name"
              },
              "value": "[variables('vnetName')]"
            },
            "firewallSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[0].id]"
            },
            "firewallManagementSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Management Subnet resource ID (required for Basic SKU)"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[1].id]"
            },
            "gatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Gateway Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[2].id]"
            },
            "managementSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Management Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[3].id]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Hub NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy hub VNet with NSG and Private DNS Zone"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-spoke-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').spoke]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "deployNatGateway": {
            "value": "[variables('deploySpokeNatGateway')]"
          },
          "routeTableId": "[if(variables('deployFirewall'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('route-tables-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.spokeRouteTableId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('spokeTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14497497605920689226"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space CIDR"
              }
            },
            "deployNatGateway": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Deploy NAT Gateway (false when firewall handles outbound)"
              }
            },
            "routeTableId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Route table ID to associate with subnets (when using firewall)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "nsgName": "[format('nsg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "natGatewayName": "[format('nat-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "natPublicIpName": "[format('pip-nat-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "workloadSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 0)]",
            "dataSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 1)]",
            "appSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 2)]",
            "hasRouteTable": "[not(empty(parameters('routeTableId')))]"
          },
          "resources": [
            {
              "condition": "[parameters('deployNatGateway')]",
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('natPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for NAT Gateway (only deployed when no firewall)"
              }
            },
            {
              "condition": "[parameters('deployNatGateway')]",
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2024-01-01",
              "name": "[variables('natGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIpAddresses": [
                  {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName'))]"
                  }
                ],
                "idleTimeoutInMinutes": 4
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName'))]"
              ],
              "metadata": {
                "description": "NAT Gateway for outbound internet (only deployed when no firewall)"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "description": "Allow inbound traffic within VNet"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Azure Load Balancer health probes"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Default deny all inbound traffic"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Spoke NSG with default deny inbound rules"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-workload",
                    "properties": {
                      "addressPrefix": "[variables('workloadSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  },
                  {
                    "name": "snet-data",
                    "properties": {
                      "addressPrefix": "[variables('dataSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  },
                  {
                    "name": "snet-app",
                    "properties": {
                      "addressPrefix": "[variables('appSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ],
              "metadata": {
                "description": "Spoke VNet with workload subnets"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet name"
              },
              "value": "[variables('vnetName')]"
            },
            "workloadSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Workload Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[0].id]"
            },
            "dataSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Data Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[1].id]"
            },
            "appSubnetId": {
              "type": "string",
              "metadata": {
                "description": "App Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[2].id]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Spoke NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "natGatewayId": {
              "type": "string",
              "metadata": {
                "description": "NAT Gateway resource ID (empty if firewall deployed)"
              },
              "value": "[if(parameters('deployNatGateway'), resourceId('Microsoft.Network/natGateways', variables('natGatewayName')), '')]"
            },
            "natGatewayPublicIp": {
              "type": "string",
              "metadata": {
                "description": "NAT Gateway public IP address (empty if firewall deployed)"
              },
              "value": "[if(parameters('deployNatGateway'), reference(resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName')), '2024-01-01').ipAddress, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('route-tables-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy spoke VNet with conditional NAT Gateway"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('monitoring-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').monitor]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "dailyCapGb": {
            "value": "[parameters('logAnalyticsDailyCapGb')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18252502359208825681"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "dailyCapGb": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "Daily ingestion cap in GB (0 = no cap, minimum 0.023 GB if set). Use decimal values e.g., 0.5 for ~500MB"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "workspaceName": "[format('log-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "dailyQuotaGbValue": "[json(parameters('dailyCapGb'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "workspaceCapping": "[if(greater(variables('dailyQuotaGbValue'), 0), createObject('dailyQuotaGb', variables('dailyQuotaGbValue')), null())]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "metadata": {
                "description": "Log Analytics Workspace with daily cap for cost control"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name"
              },
              "value": "[variables('workspaceName')]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace customer ID (for agent configuration)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2023-09-01').customerId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Log Analytics Workspace with daily cap"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('backup-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').backup]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12941598578613445886"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vaultName": "[format('rsv-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2024-04-01",
              "name": "[variables('vaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "RS0",
                "tier": "Standard"
              },
              "properties": {
                "publicNetworkAccess": "Enabled",
                "securitySettings": {
                  "softDeleteSettings": {
                    "softDeleteState": "Enabled",
                    "softDeleteRetentionPeriodInDays": 14
                  }
                }
              },
              "metadata": {
                "description": "Recovery Services Vault for VM backup with LRS storage"
              }
            }
          ],
          "outputs": {
            "vaultId": {
              "type": "string",
              "metadata": {
                "description": "Recovery Services Vault resource ID"
              },
              "value": "[resourceId('Microsoft.RecoveryServices/vaults', variables('vaultName'))]"
            },
            "vaultName": {
              "type": "string",
              "metadata": {
                "description": "Recovery Services Vault name"
              },
              "value": "[variables('vaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Recovery Services Vault for VM backup"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('migrate-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').migrate]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4248499830919610573"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags (not supported by Azure Migrate API, kept for interface consistency)"
              }
            }
          },
          "variables": {
            "projectName": "[format('migrate-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Migrate/migrateProjects",
              "apiVersion": "2020-05-01",
              "name": "[variables('projectName')]",
              "location": "[parameters('location')]",
              "properties": {},
              "metadata": {
                "description": "Azure Migrate Project for VMware discovery and assessment"
              }
            }
          ],
          "outputs": {
            "projectId": {
              "type": "string",
              "metadata": {
                "description": "Azure Migrate Project resource ID"
              },
              "value": "[resourceId('Microsoft.Migrate/migrateProjects', variables('projectName'))]"
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "Azure Migrate Project name"
              },
              "value": "[variables('projectName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Azure Migrate project for VMware assessment"
      }
    },
    {
      "condition": "[variables('deployFirewall')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('firewall-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "firewallSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallSubnetId.value]"
          },
          "firewallManagementSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallManagementSubnetId.value]"
          },
          "spokeAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "onPremisesAddressSpace": {
            "value": "[parameters('onPremisesAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2343922736670784758"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "firewallSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Subnet resource ID"
              }
            },
            "firewallManagementSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Management Subnet resource ID (required for Basic SKU)"
              }
            },
            "spokeAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space for firewall rules"
              }
            },
            "onPremisesAddressSpace": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "On-premises address space for VPN routing (optional)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "firewallName": "[format('fw-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallPolicyName": "[format('fwpol-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallPublicIpName": "[format('pip-fw-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallMgmtPublicIpName": "[format('pip-fw-mgmt-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "hasOnPremises": "[not(empty(parameters('onPremisesAddressSpace')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for Azure Firewall data traffic"
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallMgmtPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for Azure Firewall management traffic (required for Basic SKU)"
              }
            },
            {
              "type": "Microsoft.Network/firewallPolicies",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallPolicyName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "tier": "Basic"
                },
                "threatIntelMode": "Alert"
              },
              "metadata": {
                "description": "Firewall Policy with Basic tier and best-practice rules"
              }
            },
            {
              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('firewallPolicyName'), 'NetworkRuleCollectionGroup')]",
              "properties": {
                "priority": 200,
                "ruleCollections": [
                  {
                    "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                    "action": {
                      "type": "Allow"
                    },
                    "name": "AllowInfrastructure",
                    "priority": 100,
                    "rules": [
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowDNS",
                        "description": "Allow DNS queries to Azure DNS",
                        "ipProtocols": [
                          "UDP",
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "168.63.129.16"
                        ],
                        "destinationPorts": [
                          "53"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowNTP",
                        "description": "Allow NTP for time synchronization",
                        "ipProtocols": [
                          "UDP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "123"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowICMP",
                        "description": "Allow all ICMP traffic for diagnostics",
                        "ipProtocols": [
                          "ICMP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOutboundHTTP",
                        "description": "Allow outbound HTTP traffic",
                        "ipProtocols": [
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "80"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOutboundHTTPS",
                        "description": "Allow outbound HTTPS traffic",
                        "ipProtocols": [
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "443"
                        ]
                      }
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
              ],
              "metadata": {
                "description": "Network rules for DNS, NTP, ICMP, and Azure services"
              }
            },
            {
              "condition": "[variables('hasOnPremises')]",
              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', variables('firewallPolicyName'), 'OnPremisesRuleCollectionGroup')]",
              "properties": {
                "priority": 300,
                "ruleCollections": [
                  {
                    "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                    "action": {
                      "type": "Allow"
                    },
                    "name": "AllowOnPremisesTraffic",
                    "priority": 100,
                    "rules": [
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowAzureToOnPrem",
                        "description": "Allow Azure spoke resources to reach on-premises",
                        "ipProtocols": [
                          "Any"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "[parameters('onPremisesAddressSpace')]"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOnPremToAzure",
                        "description": "Allow on-premises to reach Azure spoke resources",
                        "ipProtocols": [
                          "Any"
                        ],
                        "sourceAddresses": [
                          "[parameters('onPremisesAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      }
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', variables('firewallPolicyName'), 'NetworkRuleCollectionGroup')]"
              ],
              "metadata": {
                "description": "Network rules for on-premises connectivity (conditional)"
              }
            },
            {
              "type": "Microsoft.Network/azureFirewalls",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "AZFW_VNet",
                  "tier": "Basic"
                },
                "firewallPolicy": {
                  "id": "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]"
                },
                "ipConfigurations": [
                  {
                    "name": "fw-ipconfig",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('firewallSubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName'))]"
                      }
                    }
                  }
                ],
                "managementIpConfiguration": {
                  "name": "fw-mgmt-ipconfig",
                  "properties": {
                    "subnet": {
                      "id": "[parameters('firewallManagementSubnetId')]"
                    },
                    "publicIPAddress": {
                      "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName'))]",
                "[resourceId('Microsoft.Network/firewallPolicies', variables('firewallPolicyName'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName'))]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', variables('firewallPolicyName'), 'NetworkRuleCollectionGroup')]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', variables('firewallPolicyName'), 'OnPremisesRuleCollectionGroup')]"
              ],
              "metadata": {
                "description": "Azure Firewall with Basic SKU and management IP configuration"
              }
            }
          ],
          "outputs": {
            "firewallId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall resource ID"
              },
              "value": "[resourceId('Microsoft.Network/azureFirewalls', variables('firewallName'))]"
            },
            "firewallName": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall name"
              },
              "value": "[variables('firewallName')]"
            },
            "firewallPrivateIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall private IP address (for UDR next hop)"
              },
              "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', variables('firewallName')), '2024-01-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "firewallPublicIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName')), '2024-01-01').ipAddress]"
            },
            "firewallMgmtPublicIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall management public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName')), '2024-01-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Azure Firewall Basic with best-practice rules (optional)"
      }
    },
    {
      "condition": "[variables('deployFirewall')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('route-tables-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "firewallPrivateIp": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallPrivateIp.value]"
          },
          "spokeAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "onPremisesAddressSpace": {
            "value": "[parameters('onPremisesAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14641395845912062588"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "firewallPrivateIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall private IP address for next hop"
              }
            },
            "spokeAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space (for Gateway UDR)"
              }
            },
            "onPremisesAddressSpace": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "On-premises address space (optional, for spoke routing)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "spokeRouteTableName": "[format('rt-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "gatewayRouteTableName": "[format('rt-gateway-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "hasOnPremises": "[not(empty(parameters('onPremisesAddressSpace')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2024-01-01",
              "name": "[variables('spokeRouteTableName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "disableBgpRoutePropagation": false,
                "routes": "[concat(createArray(createObject('name', 'route-to-internet-via-firewall', 'properties', createObject('addressPrefix', '0.0.0.0/0', 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), if(variables('hasOnPremises'), createArray(createObject('name', 'route-to-onprem-via-firewall', 'properties', createObject('addressPrefix', parameters('onPremisesAddressSpace'), 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), createArray()))]"
              },
              "metadata": {
                "description": "Route table for spoke subnets - forces traffic through firewall"
              }
            },
            {
              "condition": "[variables('hasOnPremises')]",
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayRouteTableName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "disableBgpRoutePropagation": false,
                "routes": [
                  {
                    "name": "route-to-spoke-via-firewall",
                    "properties": {
                      "addressPrefix": "[parameters('spokeAddressSpace')]",
                      "nextHopType": "VirtualAppliance",
                      "nextHopIpAddress": "[parameters('firewallPrivateIp')]"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Route table for GatewaySubnet - forces on-prem to Azure traffic through firewall"
              }
            }
          ],
          "outputs": {
            "spokeRouteTableId": {
              "type": "string",
              "metadata": {
                "description": "Spoke route table resource ID"
              },
              "value": "[resourceId('Microsoft.Network/routeTables', variables('spokeRouteTableName'))]"
            },
            "spokeRouteTableName": {
              "type": "string",
              "metadata": {
                "description": "Spoke route table name"
              },
              "value": "[variables('spokeRouteTableName')]"
            },
            "gatewayRouteTableId": {
              "type": "string",
              "metadata": {
                "description": "Gateway route table resource ID (empty if no VPN)"
              },
              "value": "[if(variables('hasOnPremises'), resourceId('Microsoft.Network/routeTables', variables('gatewayRouteTableName')), '')]"
            },
            "gatewayRouteTableName": {
              "type": "string",
              "metadata": {
                "description": "Gateway route table name (empty if no VPN)"
              },
              "value": "[if(variables('hasOnPremises'), variables('gatewayRouteTableName'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy route tables for firewall routing (conditional)"
      }
    },
    {
      "condition": "[variables('deployVpnGateway')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('vpn-gateway-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "gatewaySubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.gatewaySubnetId.value]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6474290054408230584"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "gatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Gateway Subnet resource ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "gatewayName": "[format('vpng-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "gatewayPublicIpName": "[format('pip-vpn-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "1",
                "2",
                "3"
              ],
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for VPN Gateway (Standard SKU, Static, zone-redundant)"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "vpnGatewayGeneration": "Generation1",
                "sku": {
                  "name": "VpnGw1AZ",
                  "tier": "VpnGw1AZ"
                },
                "enableBgp": false,
                "activeActive": false,
                "ipConfigurations": [
                  {
                    "name": "vpng-ipconfig",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('gatewaySubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName'))]"
              ],
              "metadata": {
                "description": "VPN Gateway VpnGw1AZ for hybrid connectivity"
              }
            }
          ],
          "outputs": {
            "gatewayId": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('gatewayName'))]"
            },
            "gatewayName": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway name"
              },
              "value": "[variables('gatewayName')]"
            },
            "gatewayPublicIp": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName')), '2024-01-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy VPN Gateway VpnGw1AZ (optional, zone-redundant)"
      }
    },
    {
      "condition": "[variables('deployPeering')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-peering-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          },
          "hubVnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetName.value]"
          },
          "hubVnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
          },
          "spokeVnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetName.value]"
          },
          "spokeVnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
          },
          "spokeResourceGroupName": {
            "value": "[variables('rgNames').spoke]"
          },
          "allowGatewayTransit": {
            "value": "[variables('deployVpnGateway')]"
          },
          "useRemoteGateways": {
            "value": "[variables('deployVpnGateway')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18132049567408266885"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure region for deployment (unused but kept for interface consistency)"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Environment name (unused but kept for interface consistency)"
              }
            },
            "regionShort": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Region abbreviation (unused but kept for interface consistency)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources (peering has no tags but kept for consistency)"
              }
            },
            "hubVnetName": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet name"
              }
            },
            "hubVnetId": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet resource ID"
              }
            },
            "spokeVnetName": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet name"
              }
            },
            "spokeVnetId": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet resource ID"
              }
            },
            "spokeResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group name for cross-RG peering"
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow gateway transit (true when VPN Gateway is deployed in hub)"
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use remote gateways from hub (true when VPN Gateway is deployed)"
              }
            }
          },
          "variables": {
            "_location": "[parameters('location')]",
            "_environment": "[parameters('environment')]",
            "_regionShort": "[parameters('regionShort')]",
            "_tags": "[parameters('tags')]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/peer-hub-to-spoke', parameters('hubVnetName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('spokeVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": false
              },
              "metadata": {
                "description": "Peering from hub VNet to spoke VNet (allows gateway transit when VPN deployed)"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "spoke-to-hub-peering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "spokeVnetName": {
                    "value": "[parameters('spokeVnetName')]"
                  },
                  "hubVnetId": {
                    "value": "[parameters('hubVnetId')]"
                  },
                  "useRemoteGateways": {
                    "value": "[parameters('useRemoteGateways')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "8090974053434558360"
                    }
                  },
                  "parameters": {
                    "spokeVnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Spoke VNet name"
                      }
                    },
                    "hubVnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Hub VNet resource ID"
                      }
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Use remote gateways from hub (true when VPN Gateway is deployed)"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/peer-spoke-to-hub', parameters('spokeVnetName'))]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('hubVnetId')]"
                        },
                        "allowVirtualNetworkAccess": true,
                        "allowForwardedTraffic": true,
                        "allowGatewayTransit": false,
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      },
                      "metadata": {
                        "description": "Peering from spoke VNet to hub VNet (uses remote gateways when VPN deployed)"
                      }
                    }
                  ],
                  "outputs": {
                    "peeringId": {
                      "type": "string",
                      "metadata": {
                        "description": "Spoke to Hub peering resource ID"
                      },
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-spoke-to-hub', parameters('spokeVnetName')), '/')[0], split(format('{0}/peer-spoke-to-hub', parameters('spokeVnetName')), '/')[1])]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[0], split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[1])]"
              ],
              "metadata": {
                "description": "Peering from spoke VNet to hub VNet (uses remote gateways when VPN deployed)"
              }
            }
          ],
          "outputs": {
            "hubToSpokePeeringId": {
              "type": "string",
              "metadata": {
                "description": "Hub to Spoke peering resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[0], split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[1])]"
            },
            "spokeToHubPeeringId": {
              "type": "string",
              "metadata": {
                "description": "Spoke to Hub peering resource ID"
              },
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('spokeResourceGroupName')), 'Microsoft.Resources/deployments', 'spoke-to-hub-peering'), '2025-04-01').outputs.peeringId.value]"
            },
            "gatewayTransitEnabled": {
              "type": "bool",
              "metadata": {
                "description": "Gateway transit enabled status"
              },
              "value": "[parameters('allowGatewayTransit')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Configure hub-spoke VNet peering (conditional)"
      }
    }
  ],
  "outputs": {
    "deploymentScenario": {
      "type": "string",
      "metadata": {
        "description": "Deployment scenario used"
      },
      "value": "[parameters('scenario')]"
    },
    "featureFlags": {
      "type": "object",
      "metadata": {
        "description": "Feature flags derived from scenario"
      },
      "value": {
        "firewall": "[variables('deployFirewall')]",
        "vpnGateway": "[variables('deployVpnGateway')]",
        "natGateway": "[variables('deploySpokeNatGateway')]",
        "peering": "[variables('deployPeering')]"
      }
    },
    "resourceGroupNames": {
      "type": "object",
      "metadata": {
        "description": "Resource group names for reference"
      },
      "value": "[variables('rgNames')]"
    },
    "hubVnetId": {
      "type": "string",
      "metadata": {
        "description": "Hub VNet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
    },
    "spokeVnetId": {
      "type": "string",
      "metadata": {
        "description": "Spoke VNet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').monitor), 'Microsoft.Resources/deployments', format('monitoring-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.workspaceId.value]"
    },
    "recoveryServicesVaultId": {
      "type": "string",
      "metadata": {
        "description": "Recovery Services Vault ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').backup), 'Microsoft.Resources/deployments', format('backup-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vaultId.value]"
    },
    "migrateProjectId": {
      "type": "string",
      "metadata": {
        "description": "Azure Migrate Project ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').migrate), 'Microsoft.Resources/deployments', format('migrate-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.projectId.value]"
    },
    "natGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "NAT Gateway public IP address (if deployed)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.natGatewayPublicIp.value]"
    },
    "firewallPrivateIp": {
      "type": "string",
      "metadata": {
        "description": "Azure Firewall private IP (if deployed)"
      },
      "value": "[if(and(variables('deployFirewall'), not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01'), null()))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallPrivateIp.value, '')]"
    },
    "vpnGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "VPN Gateway public IP (if deployed)"
      },
      "value": "[if(and(variables('deployVpnGateway'), not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix'))), '2025-04-01'), null()))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.gatewayPublicIp.value, '')]"
    }
  }
}