{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4881800088761256721"
    }
  },
  "parameters": {
    "scenario": {
      "type": "string",
      "defaultValue": "baseline",
      "allowedValues": [
        "baseline",
        "firewall",
        "vpn",
        "full"
      ],
      "metadata": {
        "description": "Deployment scenario preset (determines which optional services are deployed)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "allowedValues": [
        "swedencentral",
        "germanywestcentral"
      ],
      "metadata": {
        "description": "Primary deployment region"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name for resource naming and tagging"
      }
    },
    "owner": {
      "type": "string",
      "metadata": {
        "description": "Owner email or team name (required for tagging)"
      }
    },
    "hubVnetAddressSpace": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Hub VNet address space CIDR"
      }
    },
    "spokeVnetAddressSpace": {
      "type": "string",
      "defaultValue": "10.1.0.0/16",
      "metadata": {
        "description": "Spoke VNet address space CIDR"
      }
    },
    "onPremisesAddressSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "On-premises network address space CIDR (for VPN routing)"
      }
    },
    "logAnalyticsDailyCapGb": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "Log Analytics daily ingestion cap in GB (decimal, e.g. 0.5 for ~500MB)"
      }
    },
    "budgetAmount": {
      "type": "int",
      "defaultValue": 500,
      "minValue": 100,
      "maxValue": 10000,
      "metadata": {
        "description": "Monthly budget amount in USD"
      }
    },
    "budgetAlertEmail": {
      "type": "string",
      "defaultValue": "[parameters('owner')]",
      "metadata": {
        "description": "Budget alert email address"
      }
    },
    "deploymentTimestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-01')]",
      "metadata": {
        "description": "Deployment timestamp for budget start date"
      }
    }
  },
  "variables": {
    "deployFirewall": "[or(equals(parameters('scenario'), 'firewall'), equals(parameters('scenario'), 'full'))]",
    "deployVpnGateway": "[or(equals(parameters('scenario'), 'vpn'), equals(parameters('scenario'), 'full'))]",
    "uniqueSuffix": "[uniqueString(subscription().subscriptionId)]",
    "regionAbbreviations": {
      "swedencentral": "swc",
      "germanywestcentral": "gwc"
    },
    "regionShort": "[variables('regionAbbreviations')[parameters('location')]]",
    "deployPeering": "[or(variables('deployFirewall'), variables('deployVpnGateway'))]",
    "deploySpokeNatGateway": "[not(variables('deployFirewall'))]",
    "sharedServicesTags": {
      "Environment": "slz",
      "Owner": "[parameters('owner')]",
      "Project": "smb-landing-zone",
      "ManagedBy": "Bicep"
    },
    "spokeTags": {
      "Environment": "[parameters('environment')]",
      "Owner": "[parameters('owner')]",
      "Project": "smb-landing-zone",
      "ManagedBy": "Bicep"
    },
    "rgNames": {
      "hub": "[format('rg-hub-slz-{0}', variables('regionShort'))]",
      "spoke": "[format('rg-spoke-{0}-{1}', parameters('environment'), variables('regionShort'))]",
      "monitor": "[format('rg-monitor-slz-{0}', variables('regionShort'))]",
      "backup": "[format('rg-backup-slz-{0}', variables('regionShort'))]",
      "migrate": "[format('rg-migrate-slz-{0}', variables('regionShort'))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('policy-assignments-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14525703166816057413"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "swedencentral",
              "metadata": {
                "description": "Location for policy assignment metadata"
              }
            },
            "allowedLocations": {
              "type": "array",
              "defaultValue": [
                "swedencentral",
                "germanywestcentral",
                "global"
              ],
              "metadata": {
                "description": "Allowed Azure regions for resources"
              }
            },
            "allowedVmSkus": {
              "type": "array",
              "defaultValue": [
                "Standard_B1ls",
                "Standard_B1s",
                "Standard_B1ms",
                "Standard_B2s",
                "Standard_B2ms",
                "Standard_B2ls_v2",
                "Standard_B2s_v2",
                "Standard_B2ms_v2",
                "Standard_B4ms",
                "Standard_B4ls_v2",
                "Standard_B4s_v2",
                "Standard_B4ms_v2",
                "Standard_B8ms",
                "Standard_B8ls_v2",
                "Standard_B8s_v2",
                "Standard_B8ms_v2",
                "Standard_D2s_v5",
                "Standard_D4s_v5",
                "Standard_D8s_v5",
                "Standard_D16s_v5",
                "Standard_D2ds_v5",
                "Standard_D4ds_v5",
                "Standard_D8ds_v5",
                "Standard_D2s_v6",
                "Standard_D4s_v6",
                "Standard_D8s_v6",
                "Standard_E2s_v5",
                "Standard_E4s_v5",
                "Standard_E8s_v5",
                "Standard_E2ds_v5",
                "Standard_E4ds_v5",
                "Standard_E2s_v6",
                "Standard_E4s_v6"
              ],
              "metadata": {
                "description": "Allowed VM SKUs (B-series and D/E v5/v6 series)"
              }
            }
          },
          "variables": {
            "policyDefinitions": {
              "allowedVmSkus": "/providers/Microsoft.Authorization/policyDefinitions/cccc23c7-8427-4f53-ad12-b6a63eb452b3",
              "noPublicIpOnNic": "/providers/Microsoft.Authorization/policyDefinitions/83a86a26-fd1f-447c-b59d-e51f44264114",
              "auditManagedDisks": "/providers/Microsoft.Authorization/policyDefinitions/06a78e20-9358-41c9-923c-fb736d382a4d",
              "auditArmVms": "/providers/Microsoft.Authorization/policyDefinitions/1d84d5fb-01f6-4d12-ba4f-4a26081d403d",
              "nsgOnSubnets": "/providers/Microsoft.Authorization/policyDefinitions/e71308d3-144b-4262-b144-efdc3cc90517",
              "closeManagementPorts": "/providers/Microsoft.Authorization/policyDefinitions/22730e10-96f6-4aac-ad84-9383d35b5917",
              "restrictNsgPorts": "/providers/Microsoft.Authorization/policyDefinitions/9daedab3-fb2d-461e-b861-71790eead4f6",
              "disableIpForwarding": "/providers/Microsoft.Authorization/policyDefinitions/88c0b9da-ce96-4b03-9635-f29a937e2900",
              "storageHttpsOnly": "/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9",
              "noPublicBlobAccess": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
              "storageTls12": "/providers/Microsoft.Authorization/policyDefinitions/fe83a0eb-a853-422d-aac2-1bffd182c5d0",
              "restrictStorageNetwork": "/providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c",
              "storageArmMigration": "/providers/Microsoft.Authorization/policyDefinitions/37e0d2fe-28a5-43d6-a273-67d37d1f5606",
              "sqlAzureAdOnly": "/providers/Microsoft.Authorization/policyDefinitions/b3a22bc9-66de-45fb-98fa-00f5df42f41a",
              "sqlNoPublicAccess": "/providers/Microsoft.Authorization/policyDefinitions/1b8ca024-1d5c-4dec-8995-b1a932b41780",
              "requireTag": "/providers/Microsoft.Authorization/policyDefinitions/871b6d14-10aa-478d-b590-94f262ecfa99",
              "allowedLocations": "/providers/Microsoft.Authorization/policyDefinitions/e56962a6-4747-49cd-b67b-bf8b01975c4c",
              "vmBackupRequired": "/providers/Microsoft.Authorization/policyDefinitions/013e242c-8828-4970-87b3-ab247555486d",
              "diagnosticSettings": "/providers/Microsoft.Authorization/policyDefinitions/7f89b1eb-583c-429a-8828-af049802c1d9"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Allowed VM SKUs",
                "description": "Restrict VM deployments to cost-effective B-series and D/E v5/v6 series SKUs",
                "policyDefinitionId": "[variables('policyDefinitions').allowedVmSkus]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfAllowedSKUs": {
                    "value": "[parameters('allowedVmSkus')]"
                  }
                }
              },
              "metadata": {
                "description": "Restrict VM SKUs to B-series and D/E v5/v6 series"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: No Public IPs on NICs",
                "description": "Prevent VMs from having public IP addresses for security",
                "policyDefinitionId": "[variables('policyDefinitions').noPublicIpOnNic]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny public IP addresses on VM network interfaces"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Audit Managed Disks",
                "description": "Audit VMs that do not use managed disks",
                "policyDefinitionId": "[variables('policyDefinitions').auditManagedDisks]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs not using managed disks"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-compute-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Audit ARM VMs",
                "description": "Audit VMs created using classic deployment model",
                "policyDefinitionId": "[variables('policyDefinitions').auditArmVms]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs not deployed via ARM"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: NSG on Subnets",
                "description": "Audit subnets that do not have a Network Security Group",
                "policyDefinitionId": "[variables('policyDefinitions').nsgOnSubnets]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit subnets without NSG"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Close Management Ports",
                "description": "Audit VMs with management ports (22, 3389) exposed to the internet",
                "policyDefinitionId": "[variables('policyDefinitions').closeManagementPorts]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs with management ports exposed to internet"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Restrict NSG Ports",
                "description": "Audit NSG rules that allow unrestricted access",
                "policyDefinitionId": "[variables('policyDefinitions').restrictNsgPorts]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit NSG rules with unrestricted ports"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-network-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Disable IP Forwarding",
                "description": "Deny enabling IP forwarding on network interfaces",
                "policyDefinitionId": "[variables('policyDefinitions').disableIpForwarding]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny IP forwarding on VM network interfaces"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage HTTPS Only",
                "description": "Deny storage accounts that do not require HTTPS",
                "policyDefinitionId": "[variables('policyDefinitions').storageHttpsOnly]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny storage accounts without HTTPS"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: No Public Blob Access",
                "description": "Deny public blob access on storage accounts",
                "policyDefinitionId": "[variables('policyDefinitions').noPublicBlobAccess]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny public blob access on storage accounts"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-03",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage TLS 1.2",
                "description": "Deny storage accounts with minimum TLS version below 1.2",
                "policyDefinitionId": "[variables('policyDefinitions').storageTls12]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Deny storage accounts with TLS version below 1.2"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-04",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Restrict Storage Network",
                "description": "Audit storage accounts with unrestricted network access",
                "policyDefinitionId": "[variables('policyDefinitions').restrictStorageNetwork]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit storage accounts with unrestricted network access"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-storage-05",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Storage ARM Migration",
                "description": "Audit classic storage accounts that should be migrated to ARM",
                "policyDefinitionId": "[variables('policyDefinitions').storageArmMigration]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit storage accounts not migrated to ARM"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-identity-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: SQL Azure AD Only",
                "description": "Audit SQL servers that do not use Azure AD-only authentication",
                "policyDefinitionId": "[variables('policyDefinitions').sqlAzureAdOnly]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit SQL servers without Azure AD-only authentication"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-identity-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: SQL No Public Access",
                "description": "Audit SQL servers with public network access enabled",
                "policyDefinitionId": "[variables('policyDefinitions').sqlNoPublicAccess]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit SQL servers with public network access"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-tagging-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Require Environment Tag",
                "description": "Deny resource creation without Environment tag",
                "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
                "enforcementMode": "Default",
                "parameters": {
                  "tagName": {
                    "value": "Environment"
                  }
                }
              },
              "metadata": {
                "description": "Deny resources without Environment tag"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-tagging-02",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Require Owner Tag",
                "description": "Deny resource creation without Owner tag",
                "policyDefinitionId": "[variables('policyDefinitions').requireTag]",
                "enforcementMode": "Default",
                "parameters": {
                  "tagName": {
                    "value": "Owner"
                  }
                }
              },
              "metadata": {
                "description": "Deny resources without Owner tag"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-governance-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Allowed Locations",
                "description": "Restrict resource deployment to swedencentral, germanywestcentral, and global",
                "policyDefinitionId": "[variables('policyDefinitions').allowedLocations]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfAllowedLocations": {
                    "value": "[parameters('allowedLocations')]"
                  }
                }
              },
              "metadata": {
                "description": "Restrict resource deployment to allowed regions"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-backup-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: VM Backup Required",
                "description": "Audit VMs that do not have backup configured",
                "policyDefinitionId": "[variables('policyDefinitions').vmBackupRequired]",
                "enforcementMode": "Default"
              },
              "metadata": {
                "description": "Audit VMs without backup configured"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2024-04-01",
              "name": "smb-lz-monitoring-01",
              "location": "[parameters('location')]",
              "properties": {
                "displayName": "SMB LZ: Diagnostic Settings Required",
                "description": "Audit resources that do not have diagnostic settings configured",
                "policyDefinitionId": "[variables('policyDefinitions').diagnosticSettings]",
                "enforcementMode": "Default",
                "parameters": {
                  "listOfResourceTypes": {
                    "value": [
                      "Microsoft.Compute/virtualMachines",
                      "Microsoft.Network/virtualNetworks",
                      "Microsoft.Network/networkSecurityGroups",
                      "Microsoft.Network/azureFirewalls",
                      "Microsoft.Network/bastionHosts",
                      "Microsoft.KeyVault/vaults",
                      "Microsoft.RecoveryServices/vaults",
                      "Microsoft.Sql/servers"
                    ]
                  }
                }
              },
              "metadata": {
                "description": "Audit resources without diagnostic settings"
              }
            }
          ],
          "outputs": {
            "policyAssignmentNames": {
              "type": "array",
              "metadata": {
                "description": "List of policy assignment names for reference"
              },
              "value": [
                "smb-lz-compute-01",
                "smb-lz-compute-02",
                "smb-lz-compute-03",
                "smb-lz-compute-04",
                "smb-lz-network-01",
                "smb-lz-network-02",
                "smb-lz-network-03",
                "smb-lz-network-04",
                "smb-lz-storage-01",
                "smb-lz-storage-02",
                "smb-lz-storage-03",
                "smb-lz-storage-04",
                "smb-lz-storage-05",
                "smb-lz-identity-01",
                "smb-lz-identity-02",
                "smb-lz-tagging-01",
                "smb-lz-tagging-02",
                "smb-lz-governance-01",
                "smb-lz-backup-01",
                "smb-lz-monitoring-01"
              ]
            },
            "policyCount": {
              "type": "int",
              "metadata": {
                "description": "Total number of policy assignments"
              },
              "value": 20
            }
          }
        }
      },
      "metadata": {
        "description": "Deploy 20 Azure Policy assignments at subscription scope"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('budget-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "budgetAmount": {
            "value": "[parameters('budgetAmount')]"
          },
          "alertEmail": {
            "value": "[parameters('budgetAlertEmail')]"
          },
          "startDate": {
            "value": "[parameters('deploymentTimestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9983972408414509734"
            }
          },
          "parameters": {
            "budgetAmount": {
              "type": "int",
              "defaultValue": 500,
              "minValue": 100,
              "maxValue": 10000,
              "metadata": {
                "description": "Monthly budget amount in USD"
              }
            },
            "alertEmail": {
              "type": "string",
              "metadata": {
                "description": "Email address for budget alerts"
              }
            },
            "startDate": {
              "type": "string",
              "metadata": {
                "description": "Budget start date (first day of month, format: yyyy-MM-dd)"
              }
            }
          },
          "variables": {
            "budgetName": "budget-smb-lz-monthly",
            "budgetStartDate": "[format('{0}01', substring(parameters('startDate'), 0, 8))]"
          },
          "resources": [
            {
              "type": "Microsoft.Consumption/budgets",
              "apiVersion": "2023-11-01",
              "name": "[variables('budgetName')]",
              "properties": {
                "category": "Cost",
                "amount": "[parameters('budgetAmount')]",
                "timeGrain": "Monthly",
                "timePeriod": {
                  "startDate": "[variables('budgetStartDate')]"
                },
                "notifications": {
                  "forecastAlert80": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 80,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Forecasted",
                    "locale": "en-us"
                  },
                  "actualAlert90": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 90,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Actual",
                    "locale": "en-us"
                  },
                  "actualAlert100": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 100,
                    "contactEmails": [
                      "[parameters('alertEmail')]"
                    ],
                    "thresholdType": "Actual",
                    "locale": "en-us"
                  }
                }
              },
              "metadata": {
                "description": "Monthly budget with 80% forecast and 100% actual alerts"
              }
            }
          ],
          "outputs": {
            "budgetId": {
              "type": "string",
              "metadata": {
                "description": "Budget resource ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Consumption/budgets', variables('budgetName'))]"
            },
            "budgetName": {
              "type": "string",
              "metadata": {
                "description": "Budget name"
              },
              "value": "[variables('budgetName')]"
            }
          }
        }
      },
      "metadata": {
        "description": "Deploy Cost Management budget with alerts"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('resource-groups-{0}', variables('uniqueSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "sharedServicesTags": {
            "value": "[variables('sharedServicesTags')]"
          },
          "spokeTags": {
            "value": "[variables('spokeTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6636876391667713221"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource group deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod"
              ],
              "metadata": {
                "description": "Environment name for spoke resources"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "sharedServicesTags": {
              "type": "object",
              "metadata": {
                "description": "Tags for shared services resource groups (Environment = slz)"
              }
            },
            "spokeTags": {
              "type": "object",
              "metadata": {
                "description": "Tags for spoke resource group (Environment = dev/staging/prod)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-hub-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Hub resource group - VNet, Bastion, Firewall, VPN Gateway"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-monitor-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Monitoring resource group - Log Analytics"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-backup-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Backup resource group - Recovery Services Vault"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-migrate-slz-{0}', parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('sharedServicesTags')]",
              "metadata": {
                "description": "Migration resource group - Azure Migrate Project"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-03-01",
              "name": "[format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('spokeTags')]",
              "metadata": {
                "description": "Spoke resource group - Workload VNet, NAT Gateway"
              }
            }
          ],
          "outputs": {
            "hubResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Hub resource group name"
              },
              "value": "[format('rg-hub-slz-{0}', parameters('regionShort'))]"
            },
            "hubResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Hub resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-hub-slz-{0}', parameters('regionShort')))]"
            },
            "spokeResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group name"
              },
              "value": "[format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
            },
            "spokeResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort')))]"
            },
            "monitorResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Monitor resource group name"
              },
              "value": "[format('rg-monitor-slz-{0}', parameters('regionShort'))]"
            },
            "monitorResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Monitor resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-monitor-slz-{0}', parameters('regionShort')))]"
            },
            "backupResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Backup resource group name"
              },
              "value": "[format('rg-backup-slz-{0}', parameters('regionShort'))]"
            },
            "backupResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Backup resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-backup-slz-{0}', parameters('regionShort')))]"
            },
            "migrateResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Migrate resource group name"
              },
              "value": "[format('rg-migrate-slz-{0}', parameters('regionShort'))]"
            },
            "migrateResourceGroupId": {
              "type": "string",
              "metadata": {
                "description": "Migrate resource group ID"
              },
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-migrate-slz-{0}', parameters('regionShort')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('policy-assignments-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Create 5 resource groups for landing zone workloads"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-hub-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('hubVnetAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7954595598167331020"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet address space CIDR"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "nsgName": "[format('nsg-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "privateDnsZoneName": "privatelink.azure.com",
            "firewallSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 0)]",
            "firewallMgmtSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 1)]",
            "managementSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 26, 2)]",
            "gatewaySubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 27, 6)]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Default deny all inbound traffic"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Hub NSG with default deny inbound rules"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "AzureFirewallSubnet",
                    "properties": {
                      "addressPrefix": "[variables('firewallSubnetPrefix')]"
                    }
                  },
                  {
                    "name": "AzureFirewallManagementSubnet",
                    "properties": {
                      "addressPrefix": "[variables('firewallMgmtSubnetPrefix')]"
                    }
                  },
                  {
                    "name": "GatewaySubnet",
                    "properties": {
                      "addressPrefix": "[variables('gatewaySubnetPrefix')]"
                    }
                  },
                  {
                    "name": "snet-management",
                    "properties": {
                      "addressPrefix": "[variables('managementSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ],
              "metadata": {
                "description": "Hub VNet with reserved subnets for Firewall, Firewall Management, and Gateway"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {},
              "metadata": {
                "description": "Private DNS Zone for Azure Private Link endpoints"
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('link-{0}', variables('vnetName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                },
                "registrationEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ],
              "metadata": {
                "description": "Link Private DNS Zone to Hub VNet"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet name"
              },
              "value": "[variables('vnetName')]"
            },
            "firewallSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[0].id]"
            },
            "firewallManagementSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall Management Subnet resource ID (required for Basic SKU)"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[1].id]"
            },
            "gatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Gateway Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[2].id]"
            },
            "managementSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Management Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[3].id]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Hub NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy hub VNet with NSG and Private DNS Zone"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-spoke-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').spoke]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "deployNatGateway": {
            "value": "[variables('deploySpokeNatGateway')]"
          },
          "routeTableId": "[if(variables('deployFirewall'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('route-tables-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.spokeRouteTableId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('spokeTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14497497605920689226"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space CIDR"
              }
            },
            "deployNatGateway": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Deploy NAT Gateway (false when firewall handles outbound)"
              }
            },
            "routeTableId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Route table ID to associate with subnets (when using firewall)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "nsgName": "[format('nsg-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "natGatewayName": "[format('nat-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "natPublicIpName": "[format('pip-nat-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "workloadSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 0)]",
            "dataSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 1)]",
            "appSubnetPrefix": "[cidrSubnet(parameters('vnetAddressSpace'), 25, 2)]",
            "hasRouteTable": "[not(empty(parameters('routeTableId')))]"
          },
          "resources": [
            {
              "condition": "[parameters('deployNatGateway')]",
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('natPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for NAT Gateway (only deployed when no firewall)"
              }
            },
            {
              "condition": "[parameters('deployNatGateway')]",
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2024-01-01",
              "name": "[variables('natGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIpAddresses": [
                  {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName'))]"
                  }
                ],
                "idleTimeoutInMinutes": 4
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName'))]"
              ],
              "metadata": {
                "description": "NAT Gateway for outbound internet (only deployed when no firewall)"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowVnetInbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "description": "Allow inbound traffic within VNet"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerInbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Azure Load Balancer health probes"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "description": "Default deny all inbound traffic"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Spoke NSG with default deny inbound rules"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-workload",
                    "properties": {
                      "addressPrefix": "[variables('workloadSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  },
                  {
                    "name": "snet-data",
                    "properties": {
                      "addressPrefix": "[variables('dataSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  },
                  {
                    "name": "snet-app",
                    "properties": {
                      "addressPrefix": "[variables('appSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "natGateway": "[if(parameters('deployNatGateway'), createObject('id', resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))), null())]",
                      "routeTable": "[if(variables('hasRouteTable'), createObject('id', parameters('routeTableId')), null())]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ],
              "metadata": {
                "description": "Spoke VNet with workload subnets"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet name"
              },
              "value": "[variables('vnetName')]"
            },
            "workloadSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Workload Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[0].id]"
            },
            "dataSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Data Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[1].id]"
            },
            "appSubnetId": {
              "type": "string",
              "metadata": {
                "description": "App Subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-01-01').subnets[2].id]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Spoke NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "natGatewayId": {
              "type": "string",
              "metadata": {
                "description": "NAT Gateway resource ID (empty if firewall deployed)"
              },
              "value": "[if(parameters('deployNatGateway'), resourceId('Microsoft.Network/natGateways', variables('natGatewayName')), '')]"
            },
            "natGatewayPublicIp": {
              "type": "string",
              "metadata": {
                "description": "NAT Gateway public IP address (empty if firewall deployed)"
              },
              "value": "[if(parameters('deployNatGateway'), reference(resourceId('Microsoft.Network/publicIPAddresses', variables('natPublicIpName')), '2024-01-01').ipAddress, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('route-tables-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy spoke VNet with conditional NAT Gateway"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('monitoring-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').monitor]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "dailyCapGb": {
            "value": "[parameters('logAnalyticsDailyCapGb')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18252502359208825681"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "dailyCapGb": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "Daily ingestion cap in GB (0 = no cap, minimum 0.023 GB if set). Use decimal values e.g., 0.5 for ~500MB"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "workspaceName": "[format('log-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "dailyQuotaGbValue": "[json(parameters('dailyCapGb'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "workspaceCapping": "[if(greater(variables('dailyQuotaGbValue'), 0), createObject('dailyQuotaGb', variables('dailyQuotaGbValue')), null())]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "metadata": {
                "description": "Log Analytics Workspace with daily cap for cost control"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name"
              },
              "value": "[variables('workspaceName')]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace customer ID (for agent configuration)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2023-09-01').customerId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Log Analytics Workspace with daily cap"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('backup-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').backup]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12941598578613445886"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "vaultName": "[format('rsv-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2024-04-01",
              "name": "[variables('vaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "RS0",
                "tier": "Standard"
              },
              "properties": {
                "publicNetworkAccess": "Enabled",
                "securitySettings": {
                  "softDeleteSettings": {
                    "softDeleteState": "Enabled",
                    "softDeleteRetentionPeriodInDays": 14
                  }
                }
              },
              "metadata": {
                "description": "Recovery Services Vault for VM backup with LRS storage"
              }
            }
          ],
          "outputs": {
            "vaultId": {
              "type": "string",
              "metadata": {
                "description": "Recovery Services Vault resource ID"
              },
              "value": "[resourceId('Microsoft.RecoveryServices/vaults', variables('vaultName'))]"
            },
            "vaultName": {
              "type": "string",
              "metadata": {
                "description": "Recovery Services Vault name"
              },
              "value": "[variables('vaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Recovery Services Vault for VM backup"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('migrate-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').migrate]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4248499830919610573"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags (not supported by Azure Migrate API, kept for interface consistency)"
              }
            }
          },
          "variables": {
            "projectName": "[format('migrate-smblz-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Migrate/migrateProjects",
              "apiVersion": "2020-05-01",
              "name": "[variables('projectName')]",
              "location": "[parameters('location')]",
              "properties": {},
              "metadata": {
                "description": "Azure Migrate Project for VMware discovery and assessment"
              }
            }
          ],
          "outputs": {
            "projectId": {
              "type": "string",
              "metadata": {
                "description": "Azure Migrate Project resource ID"
              },
              "value": "[resourceId('Microsoft.Migrate/migrateProjects', variables('projectName'))]"
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "Azure Migrate Project name"
              },
              "value": "[variables('projectName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('resource-groups-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Azure Migrate project for VMware assessment"
      }
    },
    {
      "condition": "[variables('deployFirewall')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('firewall-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "hubVnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
          },
          "spokeAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "onPremisesAddressSpace": {
            "value": "[parameters('onPremisesAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13225987955666730199"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "hubVnetId": {
              "type": "string",
              "metadata": {
                "description": "Hub Virtual Network resource ID"
              }
            },
            "spokeAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space for firewall rules"
              }
            },
            "onPremisesAddressSpace": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "On-premises address space for VPN routing (optional)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "firewallName": "[format('fw-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallPolicyName": "[format('fwpol-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallPublicIpName": "[format('pip-fw-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "firewallMgmtPublicIpName": "[format('pip-fw-mgmt-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "hasOnPremises": "[not(empty(parameters('onPremisesAddressSpace')))]",
            "availabilityZones": [
              1,
              2,
              3
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "1",
                "2",
                "3"
              ],
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for Azure Firewall data traffic (zone-redundant)"
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('firewallMgmtPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "1",
                "2",
                "3"
              ],
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for Azure Firewall management traffic (zone-redundant)"
              }
            },
            {
              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/NetworkRuleCollectionGroup', variables('firewallPolicyName'))]",
              "properties": {
                "priority": 200,
                "ruleCollections": [
                  {
                    "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                    "action": {
                      "type": "Allow"
                    },
                    "name": "AllowInfrastructure",
                    "priority": 100,
                    "rules": [
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowDNS",
                        "description": "Allow DNS queries to Azure DNS",
                        "ipProtocols": [
                          "UDP",
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "168.63.129.16"
                        ],
                        "destinationPorts": [
                          "53"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowNTP",
                        "description": "Allow NTP for time synchronization",
                        "ipProtocols": [
                          "UDP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "123"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowICMP",
                        "description": "Allow all ICMP traffic for diagnostics",
                        "ipProtocols": [
                          "ICMP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOutboundHTTP",
                        "description": "Allow outbound HTTP traffic",
                        "ipProtocols": [
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "80"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOutboundHTTPS",
                        "description": "Allow outbound HTTPS traffic",
                        "ipProtocols": [
                          "TCP"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "*"
                        ],
                        "destinationPorts": [
                          "443"
                        ]
                      }
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallPolicyName')))]"
              ],
              "metadata": {
                "description": "Network rules for DNS, NTP, ICMP, and Azure services"
              }
            },
            {
              "condition": "[variables('hasOnPremises')]",
              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/OnPremisesRuleCollectionGroup', variables('firewallPolicyName'))]",
              "properties": {
                "priority": 300,
                "ruleCollections": [
                  {
                    "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                    "action": {
                      "type": "Allow"
                    },
                    "name": "AllowOnPremisesTraffic",
                    "priority": 100,
                    "rules": [
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowAzureToOnPrem",
                        "description": "Allow Azure spoke resources to reach on-premises",
                        "ipProtocols": [
                          "Any"
                        ],
                        "sourceAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "[parameters('onPremisesAddressSpace')]"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      },
                      {
                        "ruleType": "NetworkRule",
                        "name": "AllowOnPremToAzure",
                        "description": "Allow on-premises to reach Azure spoke resources",
                        "ipProtocols": [
                          "Any"
                        ],
                        "sourceAddresses": [
                          "[parameters('onPremisesAddressSpace')]"
                        ],
                        "destinationAddresses": [
                          "[parameters('spokeAddressSpace')]"
                        ],
                        "destinationPorts": [
                          "*"
                        ]
                      }
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', split(format('{0}/NetworkRuleCollectionGroup', variables('firewallPolicyName')), '/')[0], split(format('{0}/NetworkRuleCollectionGroup', variables('firewallPolicyName')), '/')[1])]"
              ],
              "metadata": {
                "description": "Network rules for on-premises connectivity (conditional)"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-{0}', variables('firewallPolicyName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[variables('firewallPolicyName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tier": {
                    "value": "Basic"
                  },
                  "threatIntelMode": {
                    "value": "Alert"
                  },
                  "enableProxy": {
                    "value": false
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "16341622665990261940"
                    },
                    "name": "Firewall Policies",
                    "description": "This module deploys a Firewall Policy."
                  },
                  "definitions": {
                    "snatType": {
                      "type": "object",
                      "properties": {
                        "autoLearnPrivateRanges": {
                          "type": "string",
                          "allowedValues": [
                            "Disabled",
                            "Enabled"
                          ],
                          "metadata": {
                            "description": "Required. The operation mode for automatically learning private ranges to not be SNAT."
                          }
                        },
                        "privateRanges": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. List of private IP addresses/IP address ranges to not be SNAT."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for SNAT settings."
                      }
                    },
                    "intrusionDetectionType": {
                      "type": "object",
                      "properties": {
                        "mode": {
                          "type": "string",
                          "allowedValues": [
                            "Alert",
                            "Deny",
                            "Off"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Intrusion detection general state. When attached to a parent policy, the firewall's effective IDPS mode is the stricter mode of the two."
                          }
                        },
                        "profile": {
                          "type": "string",
                          "allowedValues": [
                            "Advanced",
                            "Basic",
                            "Extended",
                            "Standard"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. IDPS profile name. When attached to a parent policy, the firewall's effective profile is the profile name of the parent policy."
                          }
                        },
                        "configuration": {
                          "type": "object",
                          "properties": {
                            "bypassTrafficSettings": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Description of the bypass traffic rule."
                                    }
                                  },
                                  "destinationAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination IP addresses or ranges for this rule."
                                    }
                                  },
                                  "destinationIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination IpGroups for this rule."
                                    }
                                  },
                                  "destinationPorts": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination ports or ranges."
                                    }
                                  },
                                  "name": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. Name of the bypass traffic rule."
                                    }
                                  },
                                  "protocol": {
                                    "type": "string",
                                    "allowedValues": [
                                      "ANY",
                                      "ICMP",
                                      "TCP",
                                      "UDP"
                                    ],
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The rule bypass protocol."
                                    }
                                  },
                                  "sourceAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IP addresses or ranges for this rule."
                                    }
                                  },
                                  "sourceIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IpGroups for this rule."
                                    }
                                  }
                                }
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. List of rules for traffic to bypass."
                              }
                            },
                            "privateRanges": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. IDPS Private IP address ranges are used to identify traffic direction (i.e. inbound, outbound, etc.). By default, only ranges defined by IANA RFC 1918 are considered private IP addresses. To modify default ranges, specify your Private IP address ranges with this property."
                              }
                            },
                            "signatureOverrides": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. The signature id."
                                    }
                                  },
                                  "mode": {
                                    "type": "string",
                                    "allowedValues": [
                                      "Alert",
                                      "Deny",
                                      "Off"
                                    ],
                                    "metadata": {
                                      "description": "Required. The signature state."
                                    }
                                  }
                                }
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. List of specific signatures states."
                              }
                            }
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Intrusion detection configuration properties."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for intrusion detection settings."
                      }
                    },
                    "lockType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the name of lock."
                          }
                        },
                        "kind": {
                          "type": "string",
                          "allowedValues": [
                            "CanNotDelete",
                            "None",
                            "ReadOnly"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the type of lock."
                          }
                        },
                        "notes": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the notes of the lock."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a lock.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                        }
                      }
                    },
                    "managedIdentityOnlyUserAssignedType": {
                      "type": "object",
                      "properties": {
                        "userAssignedResourceIds": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a managed identity configuration. To be used if only user-assigned identities are supported by the resource provider.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                        }
                      }
                    },
                    "roleAssignmentType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                          }
                        },
                        "roleDefinitionIdOrName": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                          }
                        },
                        "principalId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                          }
                        },
                        "principalType": {
                          "type": "string",
                          "allowedValues": [
                            "Device",
                            "ForeignGroup",
                            "Group",
                            "ServicePrincipal",
                            "User"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The principal type of the assigned principal ID."
                          }
                        },
                        "description": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The description of the role assignment."
                          }
                        },
                        "condition": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                          }
                        },
                        "conditionVersion": {
                          "type": "string",
                          "allowedValues": [
                            "2.0"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Version of the condition."
                          }
                        },
                        "delegatedManagedIdentityResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a role assignment.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the Firewall Policy."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all resources."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.Network/firewallPolicies@2024-10-01#properties/tags"
                        },
                        "description": "Optional. Tags of the Firewall policy resource."
                      },
                      "nullable": true
                    },
                    "managedIdentities": {
                      "$ref": "#/definitions/managedIdentityOnlyUserAssignedType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The managed identity definition for this resource."
                      }
                    },
                    "basePolicyResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Resource ID of the base policy."
                      }
                    },
                    "enableProxy": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Enable DNS Proxy on Firewalls attached to the Firewall Policy."
                      }
                    },
                    "servers": {
                      "type": "array",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. List of Custom DNS Servers."
                      }
                    },
                    "insightsIsEnabled": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. A flag to indicate if the insights are enabled on the policy."
                      }
                    },
                    "defaultWorkspaceResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Default Log Analytics Resource ID for Firewall Policy Insights."
                      }
                    },
                    "workspaces": {
                      "type": "array",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. List of workspaces for Firewall Policy Insights."
                      }
                    },
                    "retentionDays": {
                      "type": "int",
                      "defaultValue": 365,
                      "metadata": {
                        "description": "Optional. Number of days the insights should be enabled on the policy."
                      }
                    },
                    "intrusionDetection": {
                      "$ref": "#/definitions/intrusionDetectionType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The configuration for Intrusion detection."
                      }
                    },
                    "snat": {
                      "$ref": "#/definitions/snatType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The private IP addresses/IP ranges to which traffic will not be SNAT."
                      }
                    },
                    "tier": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "allowedValues": [
                        "Premium",
                        "Standard",
                        "Basic"
                      ],
                      "metadata": {
                        "description": "Optional. Tier of Firewall Policy."
                      }
                    },
                    "threatIntelMode": {
                      "type": "string",
                      "defaultValue": "Deny",
                      "allowedValues": [
                        "Alert",
                        "Deny",
                        "Off"
                      ],
                      "metadata": {
                        "description": "Optional. The operation mode for Threat Intel."
                      }
                    },
                    "allowSqlRedirect": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. A flag to indicate if SQL Redirect traffic filtering is enabled. Turning on the flag requires no rule using port 11000-11999."
                      }
                    },
                    "fqdns": {
                      "type": "array",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. List of FQDNs for the ThreatIntel Allowlist."
                      }
                    },
                    "ipAddresses": {
                      "type": "array",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. List of IP addresses for the ThreatIntel Allowlist."
                      }
                    },
                    "keyVaultSecretId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Secret ID of (base-64 encoded unencrypted PFX) Secret or Certificate object stored in KeyVault."
                      }
                    },
                    "certificateName": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Name of the CA certificate."
                      }
                    },
                    "enableTelemetry": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Optional. Enable/Disable usage telemetry for module."
                      }
                    },
                    "ruleCollectionGroups": {
                      "type": "array",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Rule collection groups."
                      }
                    },
                    "lock": {
                      "$ref": "#/definitions/lockType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The lock settings of the service."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/roleAssignmentType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Array of role assignments to create."
                      }
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "formattedRoleAssignments",
                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                      }
                    ],
                    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', 'UserAssigned', 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                    "builtInRoleNames": {
                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                    }
                  },
                  "resources": {
                    "avmTelemetry": {
                      "condition": "[parameters('enableTelemetry')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2024-03-01",
                      "name": "[format('46d3xbcp.res.network-firewallpolicy.{0}.{1}', replace('0.3.4', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                      "properties": {
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "resources": [],
                          "outputs": {
                            "telemetry": {
                              "type": "String",
                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                            }
                          }
                        }
                      }
                    },
                    "firewallPolicy": {
                      "type": "Microsoft.Network/firewallPolicies",
                      "apiVersion": "2024-10-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": "[variables('identity')]",
                      "properties": {
                        "basePolicy": "[if(not(empty(parameters('basePolicyResourceId'))), createObject('id', parameters('basePolicyResourceId')), null())]",
                        "dnsSettings": "[if(or(parameters('enableProxy'), not(equals(parameters('servers'), null()))), createObject('enableProxy', parameters('enableProxy'), 'servers', coalesce(parameters('servers'), createArray())), null())]",
                        "insights": "[if(parameters('insightsIsEnabled'), createObject('isEnabled', parameters('insightsIsEnabled'), 'logAnalyticsResources', createObject('defaultWorkspaceId', createObject('id', parameters('defaultWorkspaceResourceId')), 'workspaces', parameters('workspaces')), 'retentionDays', parameters('retentionDays')), null())]",
                        "intrusionDetection": "[parameters('intrusionDetection')]",
                        "sku": {
                          "tier": "[parameters('tier')]"
                        },
                        "snat": "[parameters('snat')]",
                        "sql": {
                          "allowSqlRedirect": "[parameters('allowSqlRedirect')]"
                        },
                        "threatIntelMode": "[parameters('threatIntelMode')]",
                        "threatIntelWhitelist": {
                          "fqdns": "[coalesce(parameters('fqdns'), createArray())]",
                          "ipAddresses": "[coalesce(parameters('ipAddresses'), createArray())]"
                        },
                        "transportSecurity": "[if(or(not(empty(coalesce(parameters('keyVaultSecretId'), createArray()))), not(empty(coalesce(parameters('certificateName'), '')))), createObject('certificateAuthority', createObject('keyVaultSecretId', parameters('keyVaultSecretId'), 'name', parameters('certificateName'))), null())]"
                      }
                    },
                    "firewallPolicy_roleAssignments": {
                      "copy": {
                        "name": "firewallPolicy_roleAssignments",
                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Network/firewallPolicies/{0}', parameters('name'))]",
                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/firewallPolicies', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                      "properties": {
                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                      },
                      "dependsOn": [
                        "firewallPolicy"
                      ]
                    },
                    "firewallPolicy_lock": {
                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                      "type": "Microsoft.Authorization/locks",
                      "apiVersion": "2020-05-01",
                      "scope": "[format('Microsoft.Network/firewallPolicies/{0}', parameters('name'))]",
                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                      "properties": {
                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                      },
                      "dependsOn": [
                        "firewallPolicy"
                      ]
                    },
                    "firewallPolicy_ruleCollectionGroups": {
                      "copy": {
                        "name": "firewallPolicy_ruleCollectionGroups",
                        "count": "[length(coalesce(parameters('ruleCollectionGroups'), createArray()))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('{0}-firewallPolicy_ruleCollectionGroups-{1}', uniqueString(subscription().id, resourceGroup().id, parameters('location')), copyIndex())]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "firewallPolicyName": {
                            "value": "[parameters('name')]"
                          },
                          "name": {
                            "value": "[coalesce(parameters('ruleCollectionGroups'), createArray())[copyIndex()].name]"
                          },
                          "priority": {
                            "value": "[coalesce(parameters('ruleCollectionGroups'), createArray())[copyIndex()].priority]"
                          },
                          "ruleCollections": {
                            "value": "[coalesce(parameters('ruleCollectionGroups'), createArray())[copyIndex()].ruleCollections]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "9817822208885453465"
                            },
                            "name": "Firewall Policy Rule Collection Groups",
                            "description": "This module deploys a Firewall Policy Rule Collection Group."
                          },
                          "parameters": {
                            "firewallPolicyName": {
                              "type": "string",
                              "metadata": {
                                "description": "Conditional. The name of the parent Firewall Policy. Required if the template is used in a standalone deployment."
                              }
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the rule collection group to deploy."
                              }
                            },
                            "priority": {
                              "type": "int",
                              "metadata": {
                                "description": "Required. Priority of the Firewall Policy Rule Collection Group resource."
                              }
                            },
                            "ruleCollections": {
                              "type": "array",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Group of Firewall Policy rule collections."
                              }
                            }
                          },
                          "resources": {
                            "firewallPolicy": {
                              "existing": true,
                              "type": "Microsoft.Network/firewallPolicies",
                              "apiVersion": "2024-10-01",
                              "name": "[parameters('firewallPolicyName')]"
                            },
                            "ruleCollectionGroup": {
                              "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                              "apiVersion": "2024-10-01",
                              "name": "[format('{0}/{1}', parameters('firewallPolicyName'), parameters('name'))]",
                              "properties": {
                                "priority": "[parameters('priority')]",
                                "ruleCollections": "[coalesce(parameters('ruleCollections'), createArray())]"
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the deployed rule collection group."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the deployed rule collection group."
                              },
                              "value": "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', parameters('firewallPolicyName'), parameters('name'))]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource group of the deployed rule collection group."
                              },
                              "value": "[resourceGroup().name]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "firewallPolicy"
                      ]
                    }
                  },
                  "outputs": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the deployed firewall policy."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the deployed firewall policy."
                      },
                      "value": "[resourceId('Microsoft.Network/firewallPolicies', parameters('name'))]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group of the deployed firewall policy."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location the resource was deployed into."
                      },
                      "value": "[reference('firewallPolicy', '2024-10-01', 'full').location]"
                    }
                  }
                }
              },
              "metadata": {
                "description": "Firewall Policy with Basic tier"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-{0}', variables('firewallName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[variables('firewallName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "azureSkuTier": {
                    "value": "Basic"
                  },
                  "virtualNetworkResourceId": {
                    "value": "[parameters('hubVnetId')]"
                  },
                  "firewallPolicyId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallPolicyName'))), '2025-04-01').outputs.resourceId.value]"
                  },
                  "publicIPResourceID": {
                    "value": "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName'))]"
                  },
                  "managementIPResourceID": {
                    "value": "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName'))]"
                  },
                  "availabilityZones": {
                    "value": "[variables('availabilityZones')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "13804372370557758807"
                    },
                    "name": "Azure Firewalls",
                    "description": "This module deploys an Azure Firewall."
                  },
                  "definitions": {
                    "natRuleCollectionType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Name of the NAT rule collection."
                          }
                        },
                        "properties": {
                          "type": "object",
                          "properties": {
                            "action": {
                              "type": "object",
                              "properties": {
                                "type": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Dnat",
                                    "Snat"
                                  ],
                                  "metadata": {
                                    "description": "Required. The type of action."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. The action type of a NAT rule collection."
                              }
                            },
                            "priority": {
                              "type": "int",
                              "minValue": 100,
                              "maxValue": 65000,
                              "metadata": {
                                "description": "Required. Priority of the NAT rule collection."
                              }
                            },
                            "rules": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. Name of the NAT rule."
                                    }
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Description of the rule."
                                    }
                                  },
                                  "protocols": {
                                    "type": "array",
                                    "allowedValues": [
                                      "Any",
                                      "ICMP",
                                      "TCP",
                                      "UDP"
                                    ],
                                    "metadata": {
                                      "description": "Required. Array of AzureFirewallNetworkRuleProtocols applicable to this NAT rule."
                                    }
                                  },
                                  "destinationAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination IP addresses for this rule. Supports IP ranges, prefixes, and service tags."
                                    }
                                  },
                                  "destinationPorts": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination ports."
                                    }
                                  },
                                  "sourceAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IP addresses for this rule."
                                    }
                                  },
                                  "sourceIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IpGroups for this rule."
                                    }
                                  },
                                  "translatedAddress": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The translated address for this NAT rule."
                                    }
                                  },
                                  "translatedFqdn": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The translated FQDN for this NAT rule."
                                    }
                                  },
                                  "translatedPort": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. The translated port for this NAT rule."
                                    }
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. Collection of rules used by a NAT rule collection."
                              }
                            }
                          },
                          "metadata": {
                            "description": "Required. Properties of the azure firewall NAT rule collection."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for a NAT rule collection."
                      }
                    },
                    "applicationRuleCollectionType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Name of the application rule collection."
                          }
                        },
                        "properties": {
                          "type": "object",
                          "properties": {
                            "action": {
                              "type": "object",
                              "properties": {
                                "type": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Allow",
                                    "Deny"
                                  ],
                                  "metadata": {
                                    "description": "Required. The type of action."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. The action type of a rule collection."
                              }
                            },
                            "priority": {
                              "type": "int",
                              "minValue": 100,
                              "maxValue": 65000,
                              "metadata": {
                                "description": "Required. Priority of the application rule collection."
                              }
                            },
                            "rules": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. Name of the application rule."
                                    }
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Description of the rule."
                                    }
                                  },
                                  "protocols": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "port": {
                                          "type": "int",
                                          "nullable": true,
                                          "maxValue": 64000,
                                          "metadata": {
                                            "description": "Optional. Port number for the protocol."
                                          }
                                        },
                                        "protocolType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Http",
                                            "Https",
                                            "Mssql"
                                          ],
                                          "metadata": {
                                            "description": "Required. Protocol type."
                                          }
                                        }
                                      }
                                    },
                                    "metadata": {
                                      "description": "Required. Array of ApplicationRuleProtocols."
                                    }
                                  },
                                  "fqdnTags": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of FQDN Tags for this rule."
                                    }
                                  },
                                  "targetFqdns": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of FQDNs for this rule."
                                    }
                                  },
                                  "sourceAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IP addresses for this rule."
                                    }
                                  },
                                  "sourceIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IpGroups for this rule."
                                    }
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. Collection of rules used by a application rule collection."
                              }
                            }
                          },
                          "metadata": {
                            "description": "Required. Properties of the azure firewall application rule collection."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for an application rule collection."
                      }
                    },
                    "networkRuleCollectionType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Name of the network rule collection."
                          }
                        },
                        "properties": {
                          "type": "object",
                          "properties": {
                            "action": {
                              "type": "object",
                              "properties": {
                                "type": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Allow",
                                    "Deny"
                                  ],
                                  "metadata": {
                                    "description": "Required. The type of action."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. The action type of a rule collection."
                              }
                            },
                            "priority": {
                              "type": "int",
                              "minValue": 100,
                              "maxValue": 65000,
                              "metadata": {
                                "description": "Required. Priority of the network rule collection."
                              }
                            },
                            "rules": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "metadata": {
                                      "description": "Required. Name of the network rule."
                                    }
                                  },
                                  "description": {
                                    "type": "string",
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. Description of the rule."
                                    }
                                  },
                                  "protocols": {
                                    "type": "array",
                                    "allowedValues": [
                                      "Any",
                                      "ICMP",
                                      "TCP",
                                      "UDP"
                                    ],
                                    "metadata": {
                                      "description": "Required. Array of AzureFirewallNetworkRuleProtocols."
                                    }
                                  },
                                  "destinationAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination IP addresses."
                                    }
                                  },
                                  "destinationFqdns": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination FQDNs."
                                    }
                                  },
                                  "destinationIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination IP groups for this rule."
                                    }
                                  },
                                  "destinationPorts": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of destination ports."
                                    }
                                  },
                                  "sourceAddresses": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IP addresses for this rule."
                                    }
                                  },
                                  "sourceIpGroups": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "nullable": true,
                                    "metadata": {
                                      "description": "Optional. List of source IpGroups for this rule."
                                    }
                                  }
                                }
                              },
                              "metadata": {
                                "description": "Required. Collection of rules used by a network rule collection."
                              }
                            }
                          },
                          "metadata": {
                            "description": "Required. Properties of the azure firewall network rule collection."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for a network rule collection."
                      }
                    },
                    "hubIPAddressesType": {
                      "type": "object",
                      "properties": {
                        "privateIPAddress": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Private IP Address associated with AzureFirewall."
                          }
                        },
                        "publicIPs": {
                          "type": "object",
                          "properties": {
                            "addresses": {
                              "type": "array",
                              "prefixItems": [
                                {
                                  "type": "object",
                                  "properties": {
                                    "address": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Public IP."
                                      }
                                    }
                                  }
                                }
                              ],
                              "items": false,
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The list of Public IP addresses associated with AzureFirewall or IP addresses to be retained."
                              }
                            },
                            "count": {
                              "type": "int",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Public IP address count."
                              }
                            }
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. List of public IP addresses associated with AzureFirewall."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "The type for the hub IP addresses."
                      }
                    },
                    "diagnosticSettingFullType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of the diagnostic setting."
                          }
                        },
                        "logCategoriesAndGroups": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "category": {
                                "type": "string",
                                "nullable": true,
                                "metadata": {
                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                }
                              },
                              "categoryGroup": {
                                "type": "string",
                                "nullable": true,
                                "metadata": {
                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                }
                              },
                              "enabled": {
                                "type": "bool",
                                "nullable": true,
                                "metadata": {
                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                }
                              }
                            }
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                          }
                        },
                        "metricCategories": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "category": {
                                "type": "string",
                                "metadata": {
                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                }
                              },
                              "enabled": {
                                "type": "bool",
                                "nullable": true,
                                "metadata": {
                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                }
                              }
                            }
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                          }
                        },
                        "logAnalyticsDestinationType": {
                          "type": "string",
                          "allowedValues": [
                            "AzureDiagnostics",
                            "Dedicated"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                          }
                        },
                        "workspaceResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                          }
                        },
                        "storageAccountResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                          }
                        },
                        "eventHubAuthorizationRuleResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                          }
                        },
                        "eventHubName": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                          }
                        },
                        "marketplacePartnerResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                        }
                      }
                    },
                    "lockType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the name of lock."
                          }
                        },
                        "kind": {
                          "type": "string",
                          "allowedValues": [
                            "CanNotDelete",
                            "None",
                            "ReadOnly"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the type of lock."
                          }
                        },
                        "notes": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the notes of the lock."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a lock.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                        }
                      }
                    },
                    "roleAssignmentType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                          }
                        },
                        "roleDefinitionIdOrName": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                          }
                        },
                        "principalId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                          }
                        },
                        "principalType": {
                          "type": "string",
                          "allowedValues": [
                            "Device",
                            "ForeignGroup",
                            "Group",
                            "ServicePrincipal",
                            "User"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The principal type of the assigned principal ID."
                          }
                        },
                        "description": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The description of the role assignment."
                          }
                        },
                        "condition": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                          }
                        },
                        "conditionVersion": {
                          "type": "string",
                          "allowedValues": [
                            "2.0"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Version of the condition."
                          }
                        },
                        "delegatedManagedIdentityResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a role assignment.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Required. Name of the Azure Firewall."
                      }
                    },
                    "azureSkuTier": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "allowedValues": [
                        "Basic",
                        "Standard",
                        "Premium"
                      ],
                      "metadata": {
                        "description": "Optional. Tier of an Azure Firewall."
                      }
                    },
                    "virtualNetworkResourceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Conditional. Shared services Virtual Network resource ID. The virtual network ID containing AzureFirewallSubnet. If a Public IP is not provided, then the Public IP that is created as part of this module will be applied with the subnet provided in this variable. Required if `virtualHubId` is empty."
                      }
                    },
                    "publicIPResourceID": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The Public IP resource ID to associate to the Azure Firewall. If empty, then the Public IP that is created as part of this module will be applied to the Azure Firewall."
                      }
                    },
                    "additionalPublicIpConfigurations": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. This is to add any additional Public IP configurations on top of the Public IP with subnet IP configuration."
                      }
                    },
                    "publicIPAddressObject": {
                      "type": "object",
                      "defaultValue": {
                        "name": "[format('{0}-pip', parameters('name'))]"
                      },
                      "metadata": {
                        "description": "Optional. Specifies the properties of the Public IP to create and be used by the Firewall, if no existing public IP was provided."
                      }
                    },
                    "managementIPResourceID": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. The Management Public IP resource ID to associate to the AzureFirewallManagementSubnet. If empty, then the Management Public IP that is created as part of this module will be applied to the AzureFirewallManagementSubnet."
                      }
                    },
                    "managementIPAddressObject": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Optional. Specifies the properties of the Management Public IP to create and be used by Azure Firewall. If it's not provided and managementIPResourceID is empty, a '-mip' suffix will be appended to the Firewall's name."
                      }
                    },
                    "applicationRuleCollections": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/applicationRuleCollectionType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Collection of application rule collections used by Azure Firewall."
                      }
                    },
                    "networkRuleCollections": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/networkRuleCollectionType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Collection of network rule collections used by Azure Firewall."
                      }
                    },
                    "natRuleCollections": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/natRuleCollectionType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Collection of NAT rule collections used by Azure Firewall."
                      }
                    },
                    "firewallPolicyId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional. Resource ID of the Firewall Policy that should be attached."
                      }
                    },
                    "hubIPAddresses": {
                      "$ref": "#/definitions/hubIPAddressesType",
                      "nullable": true,
                      "metadata": {
                        "description": "Conditional. IP addresses associated with AzureFirewall. Required if `virtualHubId` is supplied & `publicIPResourceID` is empty."
                      }
                    },
                    "virtualHubResourceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Conditional. The virtualHub resource ID to which the firewall belongs. Required if `virtualNetworkId` is empty."
                      }
                    },
                    "threatIntelMode": {
                      "type": "string",
                      "defaultValue": "Deny",
                      "allowedValues": [
                        "Alert",
                        "Deny",
                        "Off"
                      ],
                      "metadata": {
                        "description": "Optional. The operation mode for Threat Intel."
                      }
                    },
                    "autoscaleMaxCapacity": {
                      "type": "int",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The maximum number of capacity units for this azure firewall. Use null to reset the value to the service default."
                      }
                    },
                    "autoscaleMinCapacity": {
                      "type": "int",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The minimum number of capacity units for this azure firewall. Use null to reset the value to the service default."
                      }
                    },
                    "availabilityZones": {
                      "type": "array",
                      "items": {
                        "type": "int"
                      },
                      "defaultValue": [
                        1,
                        2,
                        3
                      ],
                      "allowedValues": [
                        1,
                        2,
                        3
                      ],
                      "metadata": {
                        "description": "Optional. The list of Availability zones to use for the zone-redundant resources."
                      }
                    },
                    "enableManagementNic": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Enable/Disable to support Forced Tunneling and Packet capture scenarios."
                      }
                    },
                    "diagnosticSettings": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/diagnosticSettingFullType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The diagnostic settings of the service."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all resources."
                      }
                    },
                    "lock": {
                      "$ref": "#/definitions/lockType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The lock settings of the service."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/roleAssignmentType"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Array of role assignments to create."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.Network/azureFirewalls@2024-05-01#properties/tags"
                        },
                        "description": "Optional. Tags of the Azure Firewall resource."
                      },
                      "nullable": true
                    },
                    "enableTelemetry": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Optional. Enable/Disable usage telemetry for module."
                      }
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "additionalPublicIpConfigurationsVar",
                        "count": "[length(parameters('additionalPublicIpConfigurations'))]",
                        "input": {
                          "name": "[parameters('additionalPublicIpConfigurations')[copyIndex('additionalPublicIpConfigurationsVar')].name]",
                          "properties": {
                            "publicIPAddress": "[if(contains(parameters('additionalPublicIpConfigurations')[copyIndex('additionalPublicIpConfigurationsVar')], 'publicIPAddressResourceId'), createObject('id', parameters('additionalPublicIpConfigurations')[copyIndex('additionalPublicIpConfigurationsVar')].publicIPAddressResourceId), null())]"
                          }
                        }
                      },
                      {
                        "name": "formattedRoleAssignments",
                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                      }
                    ],
                    "enableReferencedModulesTelemetry": false,
                    "azureSkuName": "[if(empty(parameters('virtualNetworkResourceId')), 'AZFW_Hub', 'AZFW_VNet')]",
                    "requiresManagementIp": "[if(or(equals(parameters('azureSkuTier'), 'Basic'), parameters('enableManagementNic')), true(), false())]",
                    "isCreateDefaultManagementIP": "[and(empty(parameters('managementIPResourceID')), variables('requiresManagementIp'))]",
                    "builtInRoleNames": {
                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                    }
                  },
                  "resources": {
                    "avmTelemetry": {
                      "condition": "[parameters('enableTelemetry')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2024-03-01",
                      "name": "[format('46d3xbcp.res.network-azurefirewall.{0}.{1}', replace('0.9.2', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                      "properties": {
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "resources": [],
                          "outputs": {
                            "telemetry": {
                              "type": "String",
                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                            }
                          }
                        }
                      }
                    },
                    "azureFirewall": {
                      "type": "Microsoft.Network/azureFirewalls",
                      "apiVersion": "2024-10-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "zones": "[map(parameters('availabilityZones'), lambda('zone', format('{0}', lambdaVariables('zone'))))]",
                      "tags": "[parameters('tags')]",
                      "properties": "[if(equals(variables('azureSkuName'), 'AZFW_VNet'), createObject('autoscaleConfiguration', createObject('maxCapacity', parameters('autoscaleMaxCapacity'), 'minCapacity', parameters('autoscaleMinCapacity')), 'threatIntelMode', parameters('threatIntelMode'), 'firewallPolicy', if(not(empty(parameters('firewallPolicyId'))), createObject('id', parameters('firewallPolicyId')), null()), 'ipConfigurations', concat(createArray(createObject('name', if(not(empty(parameters('publicIPResourceID'))), last(split(parameters('publicIPResourceID'), '/')), tryGet(if(and(empty(parameters('publicIPResourceID')), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('publicIPAddress'), null()), 'outputs', 'name', 'value')), 'properties', union(if(equals(variables('azureSkuName'), 'AZFW_VNet'), createObject('subnet', createObject('id', format('{0}/subnets/AzureFirewallSubnet', parameters('virtualNetworkResourceId')))), createObject()), if(or(not(empty(parameters('publicIPResourceID'))), not(empty(parameters('publicIPAddressObject')))), createObject('publicIPAddress', createObject('id', if(not(empty(parameters('publicIPResourceID'))), parameters('publicIPResourceID'), tryGet(if(and(empty(parameters('publicIPResourceID')), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('publicIPAddress'), null()), 'outputs', 'resourceId', 'value')))), createObject())))), variables('additionalPublicIpConfigurationsVar')), 'managementIpConfiguration', if(variables('requiresManagementIp'), createObject('name', if(not(empty(parameters('managementIPResourceID'))), last(split(parameters('managementIPResourceID'), '/')), tryGet(if(and(variables('isCreateDefaultManagementIP'), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('managementIPAddress'), null()), 'outputs', 'name', 'value')), 'properties', createObject('subnet', createObject('id', format('{0}/subnets/AzureFirewallManagementSubnet', parameters('virtualNetworkResourceId'))), 'publicIPAddress', createObject('id', if(not(empty(parameters('managementIPResourceID'))), parameters('managementIPResourceID'), tryGet(if(and(variables('isCreateDefaultManagementIP'), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('managementIPAddress'), null()), 'outputs', 'resourceId', 'value'))))), null()), 'sku', createObject('name', variables('azureSkuName'), 'tier', parameters('azureSkuTier')), 'applicationRuleCollections', coalesce(parameters('applicationRuleCollections'), createArray()), 'natRuleCollections', coalesce(parameters('natRuleCollections'), createArray()), 'networkRuleCollections', coalesce(parameters('networkRuleCollections'), createArray())), createObject('autoscaleConfiguration', createObject('maxCapacity', parameters('autoscaleMaxCapacity'), 'minCapacity', parameters('autoscaleMinCapacity')), 'firewallPolicy', if(not(empty(parameters('firewallPolicyId'))), createObject('id', parameters('firewallPolicyId')), null()), 'sku', createObject('name', variables('azureSkuName'), 'tier', parameters('azureSkuTier')), 'ipConfigurations', if(not(empty(parameters('publicIPResourceID'))), concat(createArray(createObject('name', if(not(empty(parameters('publicIPResourceID'))), last(split(parameters('publicIPResourceID'), '/')), tryGet(if(and(empty(parameters('publicIPResourceID')), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('publicIPAddress'), null()), 'outputs', 'name', 'value')), 'properties', union(if(equals(variables('azureSkuName'), 'AZFW_VNet'), createObject('subnet', createObject('id', format('{0}/subnets/AzureFirewallSubnet', parameters('virtualNetworkResourceId')))), createObject()), if(or(not(empty(parameters('publicIPResourceID'))), not(empty(parameters('publicIPAddressObject')))), createObject('publicIPAddress', createObject('id', if(not(empty(parameters('publicIPResourceID'))), parameters('publicIPResourceID'), tryGet(if(and(empty(parameters('publicIPResourceID')), equals(variables('azureSkuName'), 'AZFW_VNet')), reference('publicIPAddress'), null()), 'outputs', 'resourceId', 'value')))), createObject())))), variables('additionalPublicIpConfigurationsVar')), null()), 'hubIPAddresses', if(not(empty(parameters('publicIPResourceID'))), null(), if(not(empty(parameters('hubIPAddresses'))), parameters('hubIPAddresses'), null())), 'virtualHub', if(not(empty(parameters('virtualHubResourceId'))), createObject('id', parameters('virtualHubResourceId')), null())))]",
                      "dependsOn": [
                        "managementIPAddress",
                        "publicIPAddress"
                      ]
                    },
                    "azureFirewall_lock": {
                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                      "type": "Microsoft.Authorization/locks",
                      "apiVersion": "2020-05-01",
                      "scope": "[format('Microsoft.Network/azureFirewalls/{0}', parameters('name'))]",
                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                      "properties": {
                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                      },
                      "dependsOn": [
                        "azureFirewall"
                      ]
                    },
                    "azureFirewall_diagnosticSettings": {
                      "copy": {
                        "name": "azureFirewall_diagnosticSettings",
                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                      },
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2021-05-01-preview",
                      "scope": "[format('Microsoft.Network/azureFirewalls/{0}', parameters('name'))]",
                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                      "properties": {
                        "copy": [
                          {
                            "name": "metrics",
                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                            "input": {
                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                              "timeGrain": null
                            }
                          },
                          {
                            "name": "logs",
                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                            "input": {
                              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                            }
                          }
                        ],
                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                      },
                      "dependsOn": [
                        "azureFirewall"
                      ]
                    },
                    "azureFirewall_roleAssignments": {
                      "copy": {
                        "name": "azureFirewall_roleAssignments",
                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Network/azureFirewalls/{0}', parameters('name'))]",
                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/azureFirewalls', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                      "properties": {
                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                      },
                      "dependsOn": [
                        "azureFirewall"
                      ]
                    },
                    "publicIPAddress": {
                      "condition": "[and(empty(parameters('publicIPResourceID')), equals(variables('azureSkuName'), 'AZFW_VNet'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('{0}-Firewall-PIP', uniqueString(subscription().id, resourceGroup().id, parameters('location')))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('publicIPAddressObject').name]"
                          },
                          "publicIpPrefixResourceId": "[if(contains(parameters('publicIPAddressObject'), 'publicIPPrefixResourceId'), if(not(empty(parameters('publicIPAddressObject').publicIPPrefixResourceId)), createObject('value', parameters('publicIPAddressObject').publicIPPrefixResourceId), createObject('value', '')), createObject('value', ''))]",
                          "publicIPAllocationMethod": "[if(contains(parameters('publicIPAddressObject'), 'publicIPAllocationMethod'), if(not(empty(parameters('publicIPAddressObject').publicIPAllocationMethod)), createObject('value', parameters('publicIPAddressObject').publicIPAllocationMethod), createObject('value', 'Static')), createObject('value', 'Static'))]",
                          "skuName": "[if(contains(parameters('publicIPAddressObject'), 'skuName'), if(not(empty(parameters('publicIPAddressObject').skuName)), createObject('value', parameters('publicIPAddressObject').skuName), createObject('value', 'Standard')), createObject('value', 'Standard'))]",
                          "skuTier": "[if(contains(parameters('publicIPAddressObject'), 'skuTier'), if(not(empty(parameters('publicIPAddressObject').skuTier)), createObject('value', parameters('publicIPAddressObject').skuTier), createObject('value', 'Regional')), createObject('value', 'Regional'))]",
                          "roleAssignments": "[if(contains(parameters('publicIPAddressObject'), 'roleAssignments'), if(not(empty(parameters('publicIPAddressObject').roleAssignments)), createObject('value', parameters('publicIPAddressObject').roleAssignments), createObject('value', createArray())), createObject('value', createArray()))]",
                          "diagnosticSettings": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'diagnosticSettings')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[coalesce(tryGet(parameters('publicIPAddressObject'), 'tags'), parameters('tags'))]"
                          },
                          "availabilityZones": {
                            "value": "[parameters('availabilityZones')]"
                          },
                          "ipTags": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'ipTags')]"
                          },
                          "ddosSettings": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'ddosSettings')]"
                          },
                          "dnsSettings": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'dnsSettings')]"
                          },
                          "idleTimeoutInMinutes": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'idleTimeoutInMinutes')]"
                          },
                          "publicIPAddressVersion": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'publicIPAddressVersion')]"
                          },
                          "lock": {
                            "value": "[parameters('lock')]"
                          },
                          "enableTelemetry": {
                            "value": "[variables('enableReferencedModulesTelemetry')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.5.1644",
                              "templateHash": "7550528442771433353"
                            },
                            "name": "Public IP Addresses",
                            "description": "This module deploys a Public IP Address."
                          },
                          "definitions": {
                            "dnsSettingsType": {
                              "type": "object",
                              "properties": {
                                "domainNameLabel": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The domain name label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
                                  }
                                },
                                "domainNameLabelScope": {
                                  "type": "string",
                                  "allowedValues": [
                                    "NoReuse",
                                    "ResourceGroupReuse",
                                    "SubscriptionReuse",
                                    "TenantReuse"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The domain name label scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
                                  }
                                },
                                "fqdn": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Fully Qualified Domain Name of the A DNS record associated with the public IP. This is the concatenation of the domainNameLabel and the regionalized DNS zone."
                                  }
                                },
                                "reverseFqdn": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The reverse FQDN. A user-visible, fully qualified domain name that resolves to this public IP address. If the reverseFqdn is specified, then a PTR DNS record is created pointing from the IP address in the in-addr.arpa domain to the reverse FQDN."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "ddosSettingsType": {
                              "type": "object",
                              "properties": {
                                "ddosProtectionPlan": {
                                  "type": "object",
                                  "properties": {
                                    "id": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The resource ID of the DDOS protection plan associated with the public IP address."
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The DDoS protection plan associated with the public IP address."
                                  }
                                },
                                "protectionMode": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Enabled"
                                  ],
                                  "metadata": {
                                    "description": "Required. The DDoS protection policy customizations."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "ipTagType": {
                              "type": "object",
                              "properties": {
                                "ipTagType": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The IP tag type."
                                  }
                                },
                                "tag": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The IP tag."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "diagnosticSettingFullType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of the diagnostic setting."
                                  }
                                },
                                "logCategoriesAndGroups": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "category": {
                                        "type": "string",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                        }
                                      },
                                      "categoryGroup": {
                                        "type": "string",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                        }
                                      },
                                      "enabled": {
                                        "type": "bool",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                        }
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                  }
                                },
                                "metricCategories": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "category": {
                                        "type": "string",
                                        "metadata": {
                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                        }
                                      },
                                      "enabled": {
                                        "type": "bool",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                        }
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                  }
                                },
                                "logAnalyticsDestinationType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AzureDiagnostics",
                                    "Dedicated"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                  }
                                },
                                "workspaceResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "storageAccountResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "eventHubAuthorizationRuleResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                  }
                                },
                                "eventHubName": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "marketplacePartnerResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.2.1"
                                }
                              }
                            },
                            "lockType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of lock."
                                  }
                                },
                                "kind": {
                                  "type": "string",
                                  "allowedValues": [
                                    "CanNotDelete",
                                    "None",
                                    "ReadOnly"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the type of lock."
                                  }
                                },
                                "notes": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the notes of the lock."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a lock.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                }
                              }
                            },
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.2.1"
                                }
                              }
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the Public IP Address."
                              }
                            },
                            "publicIpPrefixResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource ID of the Public IP Prefix object. This is only needed if you want your Public IPs created in a PIP Prefix."
                              }
                            },
                            "publicIPAllocationMethod": {
                              "type": "string",
                              "defaultValue": "Static",
                              "allowedValues": [
                                "Dynamic",
                                "Static"
                              ],
                              "metadata": {
                                "description": "Optional. The public IP address allocation method."
                              }
                            },
                            "availabilityZones": {
                              "type": "array",
                              "items": {
                                "type": "int"
                              },
                              "defaultValue": [
                                1,
                                2,
                                3
                              ],
                              "allowedValues": [
                                1,
                                2,
                                3
                              ],
                              "metadata": {
                                "description": "Optional. A list of availability zones denoting the IP allocated for the resource needs to come from."
                              }
                            },
                            "publicIPAddressVersion": {
                              "type": "string",
                              "defaultValue": "IPv4",
                              "allowedValues": [
                                "IPv4",
                                "IPv6"
                              ],
                              "metadata": {
                                "description": "Optional. IP address version."
                              }
                            },
                            "dnsSettings": {
                              "$ref": "#/definitions/dnsSettingsType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The DNS settings of the public IP address."
                              }
                            },
                            "ipTags": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/ipTagType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The list of tags associated with the public IP address."
                              }
                            },
                            "lock": {
                              "$ref": "#/definitions/lockType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The lock settings of the service."
                              }
                            },
                            "skuName": {
                              "type": "string",
                              "defaultValue": "Standard",
                              "allowedValues": [
                                "Basic",
                                "Standard"
                              ],
                              "metadata": {
                                "description": "Optional. Name of a public IP address SKU."
                              }
                            },
                            "skuTier": {
                              "type": "string",
                              "defaultValue": "Regional",
                              "allowedValues": [
                                "Global",
                                "Regional"
                              ],
                              "metadata": {
                                "description": "Optional. Tier of a public IP address SKU."
                              }
                            },
                            "ddosSettings": {
                              "$ref": "#/definitions/ddosSettingsType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The DDoS protection plan configuration associated with the public IP address."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Location for all resources."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Array of role assignments to create."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "idleTimeoutInMinutes": {
                              "type": "int",
                              "defaultValue": 4,
                              "metadata": {
                                "description": "Optional. The idle timeout of the public IP address."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Network/publicIPAddresses@2024-10-01#properties/tags"
                                },
                                "description": "Optional. Tags of the resource."
                              },
                              "nullable": true
                            },
                            "diagnosticSettings": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/diagnosticSettingFullType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The diagnostic settings of the service."
                              }
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "formattedRoleAssignments",
                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                              }
                            ],
                            "builtInRoleNames": {
                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                            }
                          },
                          "resources": {
                            "avmTelemetry": {
                              "condition": "[parameters('enableTelemetry')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2024-03-01",
                              "name": "[format('46d3xbcp.res.network-publicipaddress.{0}.{1}', replace('0.9.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                              "properties": {
                                "mode": "Incremental",
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "resources": [],
                                  "outputs": {
                                    "telemetry": {
                                      "type": "String",
                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                    }
                                  }
                                }
                              }
                            },
                            "publicIpAddress": {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2024-05-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "sku": {
                                "name": "[parameters('skuName')]",
                                "tier": "[parameters('skuTier')]"
                              },
                              "zones": "[map(parameters('availabilityZones'), lambda('zone', string(lambdaVariables('zone'))))]",
                              "properties": {
                                "ddosSettings": "[parameters('ddosSettings')]",
                                "dnsSettings": "[parameters('dnsSettings')]",
                                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                                "publicIPPrefix": "[if(not(empty(parameters('publicIpPrefixResourceId'))), createObject('id', parameters('publicIpPrefixResourceId')), null())]",
                                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                                "ipTags": "[parameters('ipTags')]"
                              }
                            },
                            "publicIpAddress_lock": {
                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                              "type": "Microsoft.Authorization/locks",
                              "apiVersion": "2020-05-01",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                              "properties": {
                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            },
                            "publicIpAddress_roleAssignments": {
                              "copy": {
                                "name": "publicIpAddress_roleAssignments",
                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                              },
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/publicIPAddresses', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                              "properties": {
                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            },
                            "publicIpAddress_diagnosticSettings": {
                              "copy": {
                                "name": "publicIpAddress_diagnosticSettings",
                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                              },
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                              "properties": {
                                "copy": [
                                  {
                                    "name": "metrics",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                    "input": {
                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                      "timeGrain": null
                                    }
                                  },
                                  {
                                    "name": "logs",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                    "input": {
                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                    }
                                  }
                                ],
                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            }
                          },
                          "outputs": {
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource group the public IP address was deployed into."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the public IP address."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the public IP address."
                              },
                              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                            },
                            "ipAddress": {
                              "type": "string",
                              "metadata": {
                                "description": "The public IP address of the public IP address resource."
                              },
                              "value": "[coalesce(tryGet(reference('publicIpAddress'), 'ipAddress'), '')]"
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "The location the resource was deployed into."
                              },
                              "value": "[reference('publicIpAddress', '2024-05-01', 'full').location]"
                            }
                          }
                        }
                      }
                    },
                    "managementIPAddress": {
                      "condition": "[and(variables('isCreateDefaultManagementIP'), equals(variables('azureSkuName'), 'AZFW_VNet'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('{0}-Firewall-MIP', uniqueString(subscription().id, resourceGroup().id, parameters('location')))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": "[if(contains(parameters('managementIPAddressObject'), 'name'), if(not(empty(parameters('managementIPAddressObject').name)), createObject('value', parameters('managementIPAddressObject').name), createObject('value', format('{0}-mip', parameters('name')))), createObject('value', format('{0}-mip', parameters('name'))))]",
                          "publicIpPrefixResourceId": "[if(contains(parameters('managementIPAddressObject'), 'managementIPPrefixResourceId'), if(not(empty(parameters('managementIPAddressObject').managementIPPrefixResourceId)), createObject('value', parameters('managementIPAddressObject').managementIPPrefixResourceId), createObject('value', '')), createObject('value', ''))]",
                          "publicIPAllocationMethod": "[if(contains(parameters('managementIPAddressObject'), 'managementIPAllocationMethod'), if(not(empty(parameters('managementIPAddressObject').managementIPAllocationMethod)), createObject('value', parameters('managementIPAddressObject').managementIPAllocationMethod), createObject('value', 'Static')), createObject('value', 'Static'))]",
                          "skuName": "[if(contains(parameters('managementIPAddressObject'), 'skuName'), if(not(empty(parameters('managementIPAddressObject').skuName)), createObject('value', parameters('managementIPAddressObject').skuName), createObject('value', 'Standard')), createObject('value', 'Standard'))]",
                          "skuTier": "[if(contains(parameters('managementIPAddressObject'), 'skuTier'), if(not(empty(parameters('managementIPAddressObject').skuTier)), createObject('value', parameters('managementIPAddressObject').skuTier), createObject('value', 'Regional')), createObject('value', 'Regional'))]",
                          "roleAssignments": "[if(contains(parameters('managementIPAddressObject'), 'roleAssignments'), if(not(empty(parameters('managementIPAddressObject').roleAssignments)), createObject('value', parameters('managementIPAddressObject').roleAssignments), createObject('value', createArray())), createObject('value', createArray()))]",
                          "diagnosticSettings": {
                            "value": "[tryGet(parameters('managementIPAddressObject'), 'diagnosticSettings')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[coalesce(tryGet(parameters('managementIPAddressObject'), 'tags'), parameters('tags'))]"
                          },
                          "availabilityZones": {
                            "value": "[parameters('availabilityZones')]"
                          },
                          "ipTags": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'ipTags')]"
                          },
                          "ddosSettings": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'ddosSettings')]"
                          },
                          "dnsSettings": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'dnsSettings')]"
                          },
                          "idleTimeoutInMinutes": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'idleTimeoutInMinutes')]"
                          },
                          "publicIPAddressVersion": {
                            "value": "[tryGet(parameters('publicIPAddressObject'), 'publicIPAddressVersion')]"
                          },
                          "lock": {
                            "value": "[parameters('lock')]"
                          },
                          "enableTelemetry": {
                            "value": "[variables('enableReferencedModulesTelemetry')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.5.1644",
                              "templateHash": "7550528442771433353"
                            },
                            "name": "Public IP Addresses",
                            "description": "This module deploys a Public IP Address."
                          },
                          "definitions": {
                            "dnsSettingsType": {
                              "type": "object",
                              "properties": {
                                "domainNameLabel": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The domain name label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
                                  }
                                },
                                "domainNameLabelScope": {
                                  "type": "string",
                                  "allowedValues": [
                                    "NoReuse",
                                    "ResourceGroupReuse",
                                    "SubscriptionReuse",
                                    "TenantReuse"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The domain name label scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
                                  }
                                },
                                "fqdn": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Fully Qualified Domain Name of the A DNS record associated with the public IP. This is the concatenation of the domainNameLabel and the regionalized DNS zone."
                                  }
                                },
                                "reverseFqdn": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The reverse FQDN. A user-visible, fully qualified domain name that resolves to this public IP address. If the reverseFqdn is specified, then a PTR DNS record is created pointing from the IP address in the in-addr.arpa domain to the reverse FQDN."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "ddosSettingsType": {
                              "type": "object",
                              "properties": {
                                "ddosProtectionPlan": {
                                  "type": "object",
                                  "properties": {
                                    "id": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The resource ID of the DDOS protection plan associated with the public IP address."
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The DDoS protection plan associated with the public IP address."
                                  }
                                },
                                "protectionMode": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Enabled"
                                  ],
                                  "metadata": {
                                    "description": "Required. The DDoS protection policy customizations."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "ipTagType": {
                              "type": "object",
                              "properties": {
                                "ipTagType": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The IP tag type."
                                  }
                                },
                                "tag": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The IP tag."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true
                              }
                            },
                            "diagnosticSettingFullType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of the diagnostic setting."
                                  }
                                },
                                "logCategoriesAndGroups": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "category": {
                                        "type": "string",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                        }
                                      },
                                      "categoryGroup": {
                                        "type": "string",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                        }
                                      },
                                      "enabled": {
                                        "type": "bool",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                        }
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                  }
                                },
                                "metricCategories": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "category": {
                                        "type": "string",
                                        "metadata": {
                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                        }
                                      },
                                      "enabled": {
                                        "type": "bool",
                                        "nullable": true,
                                        "metadata": {
                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                        }
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                  }
                                },
                                "logAnalyticsDestinationType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "AzureDiagnostics",
                                    "Dedicated"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                  }
                                },
                                "workspaceResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "storageAccountResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "eventHubAuthorizationRuleResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                  }
                                },
                                "eventHubName": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                  }
                                },
                                "marketplacePartnerResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.2.1"
                                }
                              }
                            },
                            "lockType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of lock."
                                  }
                                },
                                "kind": {
                                  "type": "string",
                                  "allowedValues": [
                                    "CanNotDelete",
                                    "None",
                                    "ReadOnly"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the type of lock."
                                  }
                                },
                                "notes": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the notes of the lock."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a lock.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                }
                              }
                            },
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.2.1"
                                }
                              }
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the Public IP Address."
                              }
                            },
                            "publicIpPrefixResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource ID of the Public IP Prefix object. This is only needed if you want your Public IPs created in a PIP Prefix."
                              }
                            },
                            "publicIPAllocationMethod": {
                              "type": "string",
                              "defaultValue": "Static",
                              "allowedValues": [
                                "Dynamic",
                                "Static"
                              ],
                              "metadata": {
                                "description": "Optional. The public IP address allocation method."
                              }
                            },
                            "availabilityZones": {
                              "type": "array",
                              "items": {
                                "type": "int"
                              },
                              "defaultValue": [
                                1,
                                2,
                                3
                              ],
                              "allowedValues": [
                                1,
                                2,
                                3
                              ],
                              "metadata": {
                                "description": "Optional. A list of availability zones denoting the IP allocated for the resource needs to come from."
                              }
                            },
                            "publicIPAddressVersion": {
                              "type": "string",
                              "defaultValue": "IPv4",
                              "allowedValues": [
                                "IPv4",
                                "IPv6"
                              ],
                              "metadata": {
                                "description": "Optional. IP address version."
                              }
                            },
                            "dnsSettings": {
                              "$ref": "#/definitions/dnsSettingsType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The DNS settings of the public IP address."
                              }
                            },
                            "ipTags": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/ipTagType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The list of tags associated with the public IP address."
                              }
                            },
                            "lock": {
                              "$ref": "#/definitions/lockType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The lock settings of the service."
                              }
                            },
                            "skuName": {
                              "type": "string",
                              "defaultValue": "Standard",
                              "allowedValues": [
                                "Basic",
                                "Standard"
                              ],
                              "metadata": {
                                "description": "Optional. Name of a public IP address SKU."
                              }
                            },
                            "skuTier": {
                              "type": "string",
                              "defaultValue": "Regional",
                              "allowedValues": [
                                "Global",
                                "Regional"
                              ],
                              "metadata": {
                                "description": "Optional. Tier of a public IP address SKU."
                              }
                            },
                            "ddosSettings": {
                              "$ref": "#/definitions/ddosSettingsType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The DDoS protection plan configuration associated with the public IP address."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Location for all resources."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Array of role assignments to create."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "idleTimeoutInMinutes": {
                              "type": "int",
                              "defaultValue": 4,
                              "metadata": {
                                "description": "Optional. The idle timeout of the public IP address."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Network/publicIPAddresses@2024-10-01#properties/tags"
                                },
                                "description": "Optional. Tags of the resource."
                              },
                              "nullable": true
                            },
                            "diagnosticSettings": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/diagnosticSettingFullType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The diagnostic settings of the service."
                              }
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "formattedRoleAssignments",
                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                              }
                            ],
                            "builtInRoleNames": {
                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                            }
                          },
                          "resources": {
                            "avmTelemetry": {
                              "condition": "[parameters('enableTelemetry')]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2024-03-01",
                              "name": "[format('46d3xbcp.res.network-publicipaddress.{0}.{1}', replace('0.9.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                              "properties": {
                                "mode": "Incremental",
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "resources": [],
                                  "outputs": {
                                    "telemetry": {
                                      "type": "String",
                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                    }
                                  }
                                }
                              }
                            },
                            "publicIpAddress": {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2024-05-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[parameters('tags')]",
                              "sku": {
                                "name": "[parameters('skuName')]",
                                "tier": "[parameters('skuTier')]"
                              },
                              "zones": "[map(parameters('availabilityZones'), lambda('zone', string(lambdaVariables('zone'))))]",
                              "properties": {
                                "ddosSettings": "[parameters('ddosSettings')]",
                                "dnsSettings": "[parameters('dnsSettings')]",
                                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                                "publicIPPrefix": "[if(not(empty(parameters('publicIpPrefixResourceId'))), createObject('id', parameters('publicIpPrefixResourceId')), null())]",
                                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                                "ipTags": "[parameters('ipTags')]"
                              }
                            },
                            "publicIpAddress_lock": {
                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                              "type": "Microsoft.Authorization/locks",
                              "apiVersion": "2020-05-01",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                              "properties": {
                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            },
                            "publicIpAddress_roleAssignments": {
                              "copy": {
                                "name": "publicIpAddress_roleAssignments",
                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                              },
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2022-04-01",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/publicIPAddresses', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                              "properties": {
                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            },
                            "publicIpAddress_diagnosticSettings": {
                              "copy": {
                                "name": "publicIpAddress_diagnosticSettings",
                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                              },
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "apiVersion": "2021-05-01-preview",
                              "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('name'))]",
                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                              "properties": {
                                "copy": [
                                  {
                                    "name": "metrics",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                    "input": {
                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                      "timeGrain": null
                                    }
                                  },
                                  {
                                    "name": "logs",
                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                    "input": {
                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                    }
                                  }
                                ],
                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                              },
                              "dependsOn": [
                                "publicIpAddress"
                              ]
                            }
                          },
                          "outputs": {
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource group the public IP address was deployed into."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the public IP address."
                              },
                              "value": "[parameters('name')]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "The resource ID of the public IP address."
                              },
                              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                            },
                            "ipAddress": {
                              "type": "string",
                              "metadata": {
                                "description": "The public IP address of the public IP address resource."
                              },
                              "value": "[coalesce(tryGet(reference('publicIpAddress'), 'ipAddress'), '')]"
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "The location the resource was deployed into."
                              },
                              "value": "[reference('publicIpAddress', '2024-05-01', 'full').location]"
                            }
                          }
                        }
                      }
                    }
                  },
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource ID of the Azure Firewall."
                      },
                      "value": "[resourceId('Microsoft.Network/azureFirewalls', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Azure Firewall."
                      },
                      "value": "[parameters('name')]"
                    },
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "The resource group the Azure firewall was deployed into."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "privateIp": {
                      "type": "string",
                      "metadata": {
                        "description": "The private IP of the Azure firewall."
                      },
                      "value": "[if(contains(reference('azureFirewall'), 'ipConfigurations'), reference('azureFirewall').ipConfigurations[0].properties.privateIPAddress, '')]"
                    },
                    "ipConfAzureFirewallSubnet": {
                      "type": "object",
                      "metadata": {
                        "description": "The Public IP configuration object for the Azure Firewall Subnet."
                      },
                      "value": "[if(contains(reference('azureFirewall'), 'ipConfigurations'), reference('azureFirewall').ipConfigurations[0], createObject())]"
                    },
                    "applicationRuleCollections": {
                      "type": "array",
                      "metadata": {
                        "description": "List of Application Rule Collections used by Azure Firewall."
                      },
                      "value": "[coalesce(parameters('applicationRuleCollections'), createArray())]"
                    },
                    "networkRuleCollections": {
                      "type": "array",
                      "metadata": {
                        "description": "List of Network Rule Collections used by Azure Firewall."
                      },
                      "value": "[coalesce(parameters('networkRuleCollections'), createArray())]"
                    },
                    "natRuleCollections": {
                      "type": "array",
                      "metadata": {
                        "description": "List of NAT rule collections used by Azure Firewall."
                      },
                      "value": "[coalesce(parameters('natRuleCollections'), createArray())]"
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location the resource was deployed into."
                      },
                      "value": "[reference('azureFirewall', '2024-10-01', 'full').location]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName'))]",
                "[resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallPolicyName')))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName'))]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', split(format('{0}/NetworkRuleCollectionGroup', variables('firewallPolicyName')), '/')[0], split(format('{0}/NetworkRuleCollectionGroup', variables('firewallPolicyName')), '/')[1])]",
                "[resourceId('Microsoft.Network/firewallPolicies/ruleCollectionGroups', split(format('{0}/OnPremisesRuleCollectionGroup', variables('firewallPolicyName')), '/')[0], split(format('{0}/OnPremisesRuleCollectionGroup', variables('firewallPolicyName')), '/')[1])]"
              ],
              "metadata": {
                "description": "Azure Firewall Basic using AVM module with pre-created PIPs"
              }
            }
          ],
          "outputs": {
            "firewallId": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallName'))), '2025-04-01').outputs.resourceId.value]"
            },
            "firewallName": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall name"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallName'))), '2025-04-01').outputs.name.value]"
            },
            "firewallPrivateIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall private IP address (for UDR next hop)"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-{0}', variables('firewallName'))), '2025-04-01').outputs.privateIp.value]"
            },
            "firewallPublicIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('firewallPublicIpName')), '2024-01-01').ipAddress]"
            },
            "firewallMgmtPublicIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall management public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('firewallMgmtPublicIpName')), '2024-01-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy Azure Firewall Basic with sequential PIP creation for reliability (optional)"
      }
    },
    {
      "condition": "[variables('deployFirewall')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('route-tables-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "firewallPrivateIp": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallPrivateIp.value]"
          },
          "spokeAddressSpace": {
            "value": "[parameters('spokeVnetAddressSpace')]"
          },
          "onPremisesAddressSpace": {
            "value": "[parameters('onPremisesAddressSpace')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14641395845912062588"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "firewallPrivateIp": {
              "type": "string",
              "metadata": {
                "description": "Azure Firewall private IP address for next hop"
              }
            },
            "spokeAddressSpace": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet address space (for Gateway UDR)"
              }
            },
            "onPremisesAddressSpace": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "On-premises address space (optional, for spoke routing)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "spokeRouteTableName": "[format('rt-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "gatewayRouteTableName": "[format('rt-gateway-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "hasOnPremises": "[not(empty(parameters('onPremisesAddressSpace')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2024-01-01",
              "name": "[variables('spokeRouteTableName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "disableBgpRoutePropagation": false,
                "routes": "[concat(createArray(createObject('name', 'route-to-internet-via-firewall', 'properties', createObject('addressPrefix', '0.0.0.0/0', 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), if(variables('hasOnPremises'), createArray(createObject('name', 'route-to-onprem-via-firewall', 'properties', createObject('addressPrefix', parameters('onPremisesAddressSpace'), 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), createArray()))]"
              },
              "metadata": {
                "description": "Route table for spoke subnets - forces traffic through firewall"
              }
            },
            {
              "condition": "[variables('hasOnPremises')]",
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayRouteTableName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "disableBgpRoutePropagation": false,
                "routes": [
                  {
                    "name": "route-to-spoke-via-firewall",
                    "properties": {
                      "addressPrefix": "[parameters('spokeAddressSpace')]",
                      "nextHopType": "VirtualAppliance",
                      "nextHopIpAddress": "[parameters('firewallPrivateIp')]"
                    }
                  }
                ]
              },
              "metadata": {
                "description": "Route table for GatewaySubnet - forces on-prem to Azure traffic through firewall"
              }
            }
          ],
          "outputs": {
            "spokeRouteTableId": {
              "type": "string",
              "metadata": {
                "description": "Spoke route table resource ID"
              },
              "value": "[resourceId('Microsoft.Network/routeTables', variables('spokeRouteTableName'))]"
            },
            "spokeRouteTableName": {
              "type": "string",
              "metadata": {
                "description": "Spoke route table name"
              },
              "value": "[variables('spokeRouteTableName')]"
            },
            "gatewayRouteTableId": {
              "type": "string",
              "metadata": {
                "description": "Gateway route table resource ID (empty if no VPN)"
              },
              "value": "[if(variables('hasOnPremises'), resourceId('Microsoft.Network/routeTables', variables('gatewayRouteTableName')), '')]"
            },
            "gatewayRouteTableName": {
              "type": "string",
              "metadata": {
                "description": "Gateway route table name (empty if no VPN)"
              },
              "value": "[if(variables('hasOnPremises'), variables('gatewayRouteTableName'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy route tables for firewall routing (conditional)"
      }
    },
    {
      "condition": "[variables('deployVpnGateway')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('vpn-gateway-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "gatewaySubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.gatewaySubnetId.value]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6474290054408230584"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resource deployment"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod",
                "slz"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "regionShort": {
              "type": "string",
              "metadata": {
                "description": "Region abbreviation for naming"
              }
            },
            "gatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Gateway Subnet resource ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "gatewayName": "[format('vpng-hub-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
            "gatewayPublicIpName": "[format('pip-vpn-{0}-{1}', parameters('environment'), parameters('regionShort'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayPublicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "1",
                "2",
                "3"
              ],
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              },
              "metadata": {
                "description": "Public IP for VPN Gateway (Standard SKU, Static, zone-redundant)"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "vpnGatewayGeneration": "Generation1",
                "sku": {
                  "name": "VpnGw1AZ",
                  "tier": "VpnGw1AZ"
                },
                "enableBgp": false,
                "activeActive": false,
                "ipConfigurations": [
                  {
                    "name": "vpng-ipconfig",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('gatewaySubnetId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName'))]"
              ],
              "metadata": {
                "description": "VPN Gateway VpnGw1AZ for hybrid connectivity"
              }
            }
          ],
          "outputs": {
            "gatewayId": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('gatewayName'))]"
            },
            "gatewayName": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway name"
              },
              "value": "[variables('gatewayName')]"
            },
            "gatewayPublicIp": {
              "type": "string",
              "metadata": {
                "description": "VPN Gateway public IP address"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('gatewayPublicIpName')), '2024-01-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Deploy VPN Gateway VpnGw1AZ (optional, zone-redundant)"
      }
    },
    {
      "condition": "[variables('deployPeering')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('networking-peering-{0}', variables('uniqueSuffix'))]",
      "resourceGroup": "[variables('rgNames').hub]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "slz"
          },
          "regionShort": {
            "value": "[variables('regionShort')]"
          },
          "tags": {
            "value": "[variables('sharedServicesTags')]"
          },
          "hubVnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetName.value]"
          },
          "hubVnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
          },
          "spokeVnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetName.value]"
          },
          "spokeVnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
          },
          "spokeResourceGroupName": {
            "value": "[variables('rgNames').spoke]"
          },
          "allowGatewayTransit": {
            "value": "[variables('deployVpnGateway')]"
          },
          "useRemoteGateways": {
            "value": "[variables('deployVpnGateway')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18132049567408266885"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure region for deployment (unused but kept for interface consistency)"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Environment name (unused but kept for interface consistency)"
              }
            },
            "regionShort": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Region abbreviation (unused but kept for interface consistency)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources (peering has no tags but kept for consistency)"
              }
            },
            "hubVnetName": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet name"
              }
            },
            "hubVnetId": {
              "type": "string",
              "metadata": {
                "description": "Hub VNet resource ID"
              }
            },
            "spokeVnetName": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet name"
              }
            },
            "spokeVnetId": {
              "type": "string",
              "metadata": {
                "description": "Spoke VNet resource ID"
              }
            },
            "spokeResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Spoke resource group name for cross-RG peering"
              }
            },
            "allowGatewayTransit": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow gateway transit (true when VPN Gateway is deployed in hub)"
              }
            },
            "useRemoteGateways": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Use remote gateways from hub (true when VPN Gateway is deployed)"
              }
            }
          },
          "variables": {
            "_location": "[parameters('location')]",
            "_environment": "[parameters('environment')]",
            "_regionShort": "[parameters('regionShort')]",
            "_tags": "[parameters('tags')]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/peer-hub-to-spoke', parameters('hubVnetName'))]",
              "properties": {
                "remoteVirtualNetwork": {
                  "id": "[parameters('spokeVnetId')]"
                },
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                "useRemoteGateways": false
              },
              "metadata": {
                "description": "Peering from hub VNet to spoke VNet (allows gateway transit when VPN deployed)"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "spoke-to-hub-peering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "spokeVnetName": {
                    "value": "[parameters('spokeVnetName')]"
                  },
                  "hubVnetId": {
                    "value": "[parameters('hubVnetId')]"
                  },
                  "useRemoteGateways": {
                    "value": "[parameters('useRemoteGateways')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "8090974053434558360"
                    }
                  },
                  "parameters": {
                    "spokeVnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Spoke VNet name"
                      }
                    },
                    "hubVnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "Hub VNet resource ID"
                      }
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Use remote gateways from hub (true when VPN Gateway is deployed)"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/peer-spoke-to-hub', parameters('spokeVnetName'))]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('hubVnetId')]"
                        },
                        "allowVirtualNetworkAccess": true,
                        "allowForwardedTraffic": true,
                        "allowGatewayTransit": false,
                        "useRemoteGateways": "[parameters('useRemoteGateways')]"
                      },
                      "metadata": {
                        "description": "Peering from spoke VNet to hub VNet (uses remote gateways when VPN deployed)"
                      }
                    }
                  ],
                  "outputs": {
                    "peeringId": {
                      "type": "string",
                      "metadata": {
                        "description": "Spoke to Hub peering resource ID"
                      },
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-spoke-to-hub', parameters('spokeVnetName')), '/')[0], split(format('{0}/peer-spoke-to-hub', parameters('spokeVnetName')), '/')[1])]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[0], split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[1])]"
              ],
              "metadata": {
                "description": "Peering from spoke VNet to hub VNet (uses remote gateways when VPN deployed)"
              }
            }
          ],
          "outputs": {
            "hubToSpokePeeringId": {
              "type": "string",
              "metadata": {
                "description": "Hub to Spoke peering resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/virtualNetworkPeerings', split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[0], split(format('{0}/peer-hub-to-spoke', parameters('hubVnetName')), '/')[1])]"
            },
            "spokeToHubPeeringId": {
              "type": "string",
              "metadata": {
                "description": "Spoke to Hub peering resource ID"
              },
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('spokeResourceGroupName')), 'Microsoft.Resources/deployments', 'spoke-to-hub-peering'), '2025-04-01').outputs.peeringId.value]"
            },
            "gatewayTransitEnabled": {
              "type": "bool",
              "metadata": {
                "description": "Gateway transit enabled status"
              },
              "value": "[parameters('allowGatewayTransit')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix')))]"
      ],
      "metadata": {
        "description": "Configure hub-spoke VNet peering (conditional)"
      }
    }
  ],
  "outputs": {
    "deploymentScenario": {
      "type": "string",
      "metadata": {
        "description": "Deployment scenario used"
      },
      "value": "[parameters('scenario')]"
    },
    "featureFlags": {
      "type": "object",
      "metadata": {
        "description": "Feature flags derived from scenario"
      },
      "value": {
        "firewall": "[variables('deployFirewall')]",
        "vpnGateway": "[variables('deployVpnGateway')]",
        "natGateway": "[variables('deploySpokeNatGateway')]",
        "peering": "[variables('deployPeering')]"
      }
    },
    "resourceGroupNames": {
      "type": "object",
      "metadata": {
        "description": "Resource group names for reference"
      },
      "value": "[variables('rgNames')]"
    },
    "hubVnetId": {
      "type": "string",
      "metadata": {
        "description": "Hub VNet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('networking-hub-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
    },
    "spokeVnetId": {
      "type": "string",
      "metadata": {
        "description": "Spoke VNet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vnetId.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').monitor), 'Microsoft.Resources/deployments', format('monitoring-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.workspaceId.value]"
    },
    "recoveryServicesVaultId": {
      "type": "string",
      "metadata": {
        "description": "Recovery Services Vault ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').backup), 'Microsoft.Resources/deployments', format('backup-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.vaultId.value]"
    },
    "migrateProjectId": {
      "type": "string",
      "metadata": {
        "description": "Azure Migrate Project ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').migrate), 'Microsoft.Resources/deployments', format('migrate-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.projectId.value]"
    },
    "natGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "NAT Gateway public IP address (if deployed)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').spoke), 'Microsoft.Resources/deployments', format('networking-spoke-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.natGatewayPublicIp.value]"
    },
    "firewallPrivateIp": {
      "type": "string",
      "metadata": {
        "description": "Azure Firewall private IP (if deployed)"
      },
      "value": "[if(and(variables('deployFirewall'), not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01'), null()))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('firewall-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.firewallPrivateIp.value, '')]"
    },
    "vpnGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "VPN Gateway public IP (if deployed)"
      },
      "value": "[if(and(variables('deployVpnGateway'), not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix'))), '2025-04-01'), null()))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames').hub), 'Microsoft.Resources/deployments', format('vpn-gateway-{0}', variables('uniqueSuffix'))), '2025-04-01').outputs.gatewayPublicIp.value, '')]"
    }
  }
}