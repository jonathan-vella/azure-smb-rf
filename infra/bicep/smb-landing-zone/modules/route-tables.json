{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14641395845912062588"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region for resource deployment"
      }
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "dev",
        "staging",
        "prod",
        "slz"
      ],
      "metadata": {
        "description": "Environment name"
      }
    },
    "regionShort": {
      "type": "string",
      "metadata": {
        "description": "Region abbreviation for naming"
      }
    },
    "firewallPrivateIp": {
      "type": "string",
      "metadata": {
        "description": "Azure Firewall private IP address for next hop"
      }
    },
    "spokeAddressSpace": {
      "type": "string",
      "metadata": {
        "description": "Spoke VNet address space (for Gateway UDR)"
      }
    },
    "onPremisesAddressSpace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "On-premises address space (optional, for spoke routing)"
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "spokeRouteTableName": "[format('rt-spoke-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
    "gatewayRouteTableName": "[format('rt-gateway-{0}-{1}', parameters('environment'), parameters('regionShort'))]",
    "hasOnPremises": "[not(empty(parameters('onPremisesAddressSpace')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/routeTables",
      "apiVersion": "2024-01-01",
      "name": "[variables('spokeRouteTableName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "disableBgpRoutePropagation": false,
        "routes": "[concat(createArray(createObject('name', 'route-to-internet-via-firewall', 'properties', createObject('addressPrefix', '0.0.0.0/0', 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), if(variables('hasOnPremises'), createArray(createObject('name', 'route-to-onprem-via-firewall', 'properties', createObject('addressPrefix', parameters('onPremisesAddressSpace'), 'nextHopType', 'VirtualAppliance', 'nextHopIpAddress', parameters('firewallPrivateIp')))), createArray()))]"
      },
      "metadata": {
        "description": "Route table for spoke subnets - forces traffic through firewall"
      }
    },
    {
      "condition": "[variables('hasOnPremises')]",
      "type": "Microsoft.Network/routeTables",
      "apiVersion": "2024-01-01",
      "name": "[variables('gatewayRouteTableName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "disableBgpRoutePropagation": false,
        "routes": [
          {
            "name": "route-to-spoke-via-firewall",
            "properties": {
              "addressPrefix": "[parameters('spokeAddressSpace')]",
              "nextHopType": "VirtualAppliance",
              "nextHopIpAddress": "[parameters('firewallPrivateIp')]"
            }
          }
        ]
      },
      "metadata": {
        "description": "Route table for GatewaySubnet - forces on-prem to Azure traffic through firewall"
      }
    }
  ],
  "outputs": {
    "spokeRouteTableId": {
      "type": "string",
      "metadata": {
        "description": "Spoke route table resource ID"
      },
      "value": "[resourceId('Microsoft.Network/routeTables', variables('spokeRouteTableName'))]"
    },
    "spokeRouteTableName": {
      "type": "string",
      "metadata": {
        "description": "Spoke route table name"
      },
      "value": "[variables('spokeRouteTableName')]"
    },
    "gatewayRouteTableId": {
      "type": "string",
      "metadata": {
        "description": "Gateway route table resource ID (empty if no VPN)"
      },
      "value": "[if(variables('hasOnPremises'), resourceId('Microsoft.Network/routeTables', variables('gatewayRouteTableName')), '')]"
    },
    "gatewayRouteTableName": {
      "type": "string",
      "metadata": {
        "description": "Gateway route table name (empty if no VPN)"
      },
      "value": "[if(variables('hasOnPremises'), variables('gatewayRouteTableName'), '')]"
    }
  }
}